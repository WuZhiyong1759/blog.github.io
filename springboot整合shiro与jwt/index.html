<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.1">
  <link rel="apple-touch-icon" sizes="180x180" href="/blog.github.io/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/blog.github.io/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/blog.github.io/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/blog.github.io/images/logo.svg" color="#222">

<link rel="stylesheet" href="/blog.github.io/css/main.css">


<link rel="stylesheet" href="/blog.github.io/lib/font-awesome/css/all.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"wuzhiyong1759.github.io","root":"/blog.github.io/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":true,"mediumzoom":false,"lazyload":true,"pangu":false,"comments":{"style":"tabs","active":null,"storage":false,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="jwt 介绍 JSON Web Token (JWT) is an open standard (RFC 7519) that defines a compact and self-contained way for securely transmitting information between parties as a JSON object. This information can be">
<meta property="og:type" content="article">
<meta property="og:title" content="springboot整合shiro与jwt">
<meta property="og:url" content="https://wuzhiyong1759.github.io/springboot%E6%95%B4%E5%90%88shiro%E4%B8%8Ejwt/index.html">
<meta property="og:site_name" content="吴志勇的博客">
<meta property="og:description" content="jwt 介绍 JSON Web Token (JWT) is an open standard (RFC 7519) that defines a compact and self-contained way for securely transmitting information between parties as a JSON object. This information can be">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://gitee.com/wu_zhiyong/pic-bed/raw/master/img/image-20201226101439507.png">
<meta property="og:image" content="https://gitee.com/wu_zhiyong/pic-bed/raw/master/img/image-20201226101958285.png">
<meta property="og:image" content="https://gitee.com/wu_zhiyong/pic-bed/raw/master/img/image-20201227121931090.png">
<meta property="og:image" content="https://gitee.com/wu_zhiyong/pic-bed/raw/master/img/image-20201227122120935.png">
<meta property="article:published_time" content="2020-12-26T01:47:05.000Z">
<meta property="article:modified_time" content="2021-03-05T11:23:24.301Z">
<meta property="article:author" content="wuzhiyong">
<meta property="article:tag" content="springboot">
<meta property="article:tag" content="jwt">
<meta property="article:tag" content="shiro">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://gitee.com/wu_zhiyong/pic-bed/raw/master/img/image-20201226101439507.png">

<link rel="canonical" href="https://wuzhiyong1759.github.io/springboot%E6%95%B4%E5%90%88shiro%E4%B8%8Ejwt/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>springboot整合shiro与jwt | 吴志勇的博客</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/blog.github.io/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">吴志勇的博客</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">学习、记录、总结、侃大山</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/blog.github.io/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/blog.github.io/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/blog.github.io/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/blog.github.io/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://wuzhiyong1759.github.io/springboot%E6%95%B4%E5%90%88shiro%E4%B8%8Ejwt/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog.github.io/images/avatar.gif">
      <meta itemprop="name" content="wuzhiyong">
      <meta itemprop="description" content="吴志勇的博客">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="吴志勇的博客">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          springboot整合shiro与jwt
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-12-26 09:47:05" itemprop="dateCreated datePublished" datetime="2020-12-26T09:47:05+08:00">2020-12-26</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-03-05 19:23:24" itemprop="dateModified" datetime="2021-03-05T19:23:24+08:00">2021-03-05</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog.github.io/categories/%E7%BC%96%E7%A8%8B/" itemprop="url" rel="index"><span itemprop="name">编程</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog.github.io/categories/%E7%BC%96%E7%A8%8B/%E5%90%8E%E7%AB%AF/" itemprop="url" rel="index"><span itemprop="name">后端</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog.github.io/categories/%E7%BC%96%E7%A8%8B/%E5%90%8E%E7%AB%AF/java/" itemprop="url" rel="index"><span itemprop="name">java</span></a>
                </span>
            </span>

          
            <span id="/blog.github.io/springboot%E6%95%B4%E5%90%88shiro%E4%B8%8Ejwt/" class="post-meta-item leancloud_visitors" data-flag-title="springboot整合shiro与jwt" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/blog.github.io/springboot%E6%95%B4%E5%90%88shiro%E4%B8%8Ejwt/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/blog.github.io/springboot%E6%95%B4%E5%90%88shiro%E4%B8%8Ejwt/" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>34k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>31 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h4 id="jwt-介绍"><a href="#jwt-介绍" class="headerlink" title="jwt 介绍"></a>jwt 介绍</h4><blockquote>
<p>JSON Web Token (JWT) is an open standard (<a href="https://tools.ietf.org/html/rfc7519" target="_blank" rel="noopener">RFC 7519</a>) that defines a compact and self-contained way for securely transmitting information between parties as a JSON object. This information can be verified and trusted because it is digitally signed. JWTs can be signed using a secret (with the <strong>HMAC</strong> algorithm) or a public/private key pair using <strong>RSA</strong> or <strong>ECDSA</strong>.</p>
<p>硬翻译：JSON Web令牌（JWT）是一个开放标准（RFC 7519），它定义了一种紧凑而独立的方法，用于在各方之间安全地将信息作为JSON对象传输。由于此信息是经过数字签名的，因此可以被验证和信任。可以使用秘密（使用HMAC算法）或使用RSA或ECDSA的公用/专用密钥对对JWT进行签名。</p>
<p>Although JWTs can be encrypted to also provide secrecy between parties, we will focus on <em>signed</em> tokens. Signed tokens can verify the <em>integrity</em> of the claims contained within it, while encrypted tokens <em>hide</em> those claims from other parties. When tokens are signed using public/private key pairs, the signature also certifies that only the party holding the private key is the one that signed it.</p>
<p>硬翻译：尽管可以对JWT进行加密以提供双方之间的保密性，但我们将重点关注已签名的令牌。签名的令牌可以验证其中包含的声明的完整性，而加密的令牌则将这些声明隐藏在其他方的面前。当使用公钥/私钥对对令牌进行签名时，签名还证明只有持有私钥的一方才是对其进行签名的一方。</p>
<p align="right">—— <a href="https://jwt.io/introduction" target="_blank" rel="noopener">jwt 官网介绍</a><p>
</blockquote>
<h4 id="jwt-能做的事"><a href="#jwt-能做的事" class="headerlink" title="jwt 能做的事"></a>jwt 能做的事</h4><ul>
<li><p><strong>Authorization</strong>: This is the most common scenario for using JWT. Once the user is logged in, each subsequent request will include the JWT, allowing the user to access routes, services, and resources that are permitted with that token. Single Sign On is a feature that widely uses JWT nowadays, because of its small overhead and its ability to be easily used across different domains.</p>
<p>授权：这是使用JWT的最常见方案。一旦用户登录，每个后续请求将包括JWT，从而允许用户访问该令牌允许的路由，服务和资源。单一登录是当今广泛使用JWT的一项功能，因为它的开销很小并且可以在不同的域中轻松使用。</p>
</li>
<li><p><strong>Information Exchange</strong>: JSON Web Tokens are a good way of securely transmitting information between parties. Because JWTs can be signed—for example, using public/private key pairs—you can be sure the senders are who they say they are. Additionally, as the signature is calculated using the header and the payload, you can also verify that the content hasn’t been tampered with.</p>
<p>信息交换：JSON Web令牌是在各方之间安全传输信息的一种好方法。因为可以对JWT进行签名（例如，使用公钥/私钥对），所以您可以确保发件人是他们所说的人。此外，由于签名是使用标头和有效负载计算的，因此您还可以验证内容是否未被篡改。</p>
</li>
</ul>
<h4 id="jwt-组成结构"><a href="#jwt-组成结构" class="headerlink" title="jwt 组成结构"></a>jwt 组成结构</h4><ul>
<li>Header</li>
<li>Payload</li>
<li>Signature</li>
</ul>
<p>整体看起来像：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xxxxx.yyyyy.zzzzz</span><br></pre></td></tr></table></figure>

<p><strong>header</strong> 通常由两部分组成：令牌的类型为JWT，以及所使用的签名算法，例如HMAC SHA256或RSA。</p>
<p>例如：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"alg"</span>: <span class="string">"HS256"</span>,</span><br><span class="line">  <span class="attr">"typ"</span>: <span class="string">"JWT"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>此JSON被Base64Url编码以形成JWT的第一部分。</p>
<p><strong>payload</strong> 令牌的第二部分是有效负载，其中包含声明。声明是有关实体（通常是用户）和其他数据的声明。共有三种类型的索赔：注册，公共和私人索赔。</p>
<p>例如：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"sub"</span>: <span class="string">"1234567890"</span>,</span><br><span class="line">  <span class="attr">"name"</span>: <span class="string">"John Doe"</span>,</span><br><span class="line">  <span class="attr">"admin"</span>: <span class="literal">true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>此JSON被Base64Url编码以形成JWT的第二部分。</p>
<p><strong>Signature</strong> 要创建签名部分，您必须获取编码的标头，编码的有效载荷，机密，标头中指定的算法，并对其进行签名。</p>
<p>例如，如果要使用HMAC SHA256算法，则将通过以下方式创建签名</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">HMACSHA256(</span><br><span class="line">  base64UrlEncode(header) + "." +</span><br><span class="line">  base64UrlEncode(payload),</span><br><span class="line">  secret)</span><br></pre></td></tr></table></figure>

<a id="more"></a>**最后把他们连在一起看起来了像这样**

<p><img data-src="https://gitee.com/wu_zhiyong/pic-bed/raw/master/img/image-20201226101439507.png" alt="image-20201226101439507"></p>
<h4 id="java-中使用"><a href="#java-中使用" class="headerlink" title="java 中使用"></a>java 中使用</h4><p>官网 提供了多种 Java 的实现。具体不同实现之间的区别请参考这篇博客：<a href="https://andaily.com/blog/?p=956" target="_blank" rel="noopener">https://andaily.com/blog/?p=956</a></p>
<p><img data-src="https://gitee.com/wu_zhiyong/pic-bed/raw/master/img/image-20201226101958285.png" alt="image-20201226101958285"></p>
<p>这里以 <strong>jose4j</strong> 为例 （官方代码：<a href="https://bitbucket.org/b_c/jose4j/wiki/JWT%20Examples）" target="_blank" rel="noopener">https://bitbucket.org/b_c/jose4j/wiki/JWT%20Examples）</a></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line">    <span class="comment">// JSON Web Token is a compact URL-safe means of representing claims/attributes to be transferred between two parties.</span></span><br><span class="line">    <span class="comment">// This example demonstrates producing and consuming a signed JWT</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Generate an RSA key pair, which will be used for signing and verification of the JWT, wrapped in a JWK</span></span><br><span class="line">    RsaJsonWebKey rsaJsonWebKey = RsaJwkGenerator.generateJwk(<span class="number">2048</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Give the JWK a Key ID (kid), which is just the polite thing to do</span></span><br><span class="line">    rsaJsonWebKey.setKeyId(<span class="string">"k1"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Create the Claims, which will be the content of the JWT</span></span><br><span class="line">    JwtClaims claims = <span class="keyword">new</span> JwtClaims();</span><br><span class="line">    claims.setIssuer(<span class="string">"Issuer"</span>);  <span class="comment">// who creates the token and signs it</span></span><br><span class="line">    claims.setAudience(<span class="string">"Audience"</span>); <span class="comment">// to whom the token is intended to be sent</span></span><br><span class="line">    claims.setExpirationTimeMinutesInTheFuture(<span class="number">10</span>); <span class="comment">// time when the token will expire (10 minutes from now)</span></span><br><span class="line">    claims.setGeneratedJwtId(); <span class="comment">// a unique identifier for the token</span></span><br><span class="line">    claims.setIssuedAtToNow();  <span class="comment">// when the token was issued/created (now)</span></span><br><span class="line">    claims.setNotBeforeMinutesInThePast(<span class="number">2</span>); <span class="comment">// time before which the token is not yet valid (2 minutes ago)</span></span><br><span class="line">    claims.setSubject(<span class="string">"subject"</span>); <span class="comment">// the subject/principal is whom the token is about</span></span><br><span class="line">    claims.setClaim(<span class="string">"email"</span>,<span class="string">"mail@example.com"</span>); <span class="comment">// additional claims/attributes about the subject can be added</span></span><br><span class="line">    List&lt;String&gt; groups = Arrays.asList(<span class="string">"group-one"</span>, <span class="string">"other-group"</span>, <span class="string">"group-three"</span>);</span><br><span class="line">    claims.setStringListClaim(<span class="string">"groups"</span>, groups); <span class="comment">// multi-valued claims work too and will end up as a JSON array</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// A JWT is a JWS and/or a JWE with JSON claims as the payload.</span></span><br><span class="line">    <span class="comment">// In this example it is a JWS so we create a JsonWebSignature object.</span></span><br><span class="line">    JsonWebSignature jws = <span class="keyword">new</span> JsonWebSignature();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// The payload of the JWS is JSON content of the JWT Claims</span></span><br><span class="line">    jws.setPayload(claims.toJson());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// The JWT is signed using the private key</span></span><br><span class="line">    jws.setKey(rsaJsonWebKey.getPrivateKey());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Set the Key ID (kid) header because it's just the polite thing to do.</span></span><br><span class="line">    <span class="comment">// We only have one key in this example but a using a Key ID helps</span></span><br><span class="line">    <span class="comment">// facilitate a smooth key rollover process</span></span><br><span class="line">    jws.setKeyIdHeaderValue(rsaJsonWebKey.getKeyId());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Set the signature algorithm on the JWT/JWS that will integrity protect the claims</span></span><br><span class="line">    jws.setAlgorithmHeaderValue(AlgorithmIdentifiers.RSA_USING_SHA256);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Sign the JWS and produce the compact serialization or the complete JWT/JWS</span></span><br><span class="line">    <span class="comment">// representation, which is a string consisting of three dot ('.') separated</span></span><br><span class="line">    <span class="comment">// base64url-encoded parts in the form Header.Payload.Signature</span></span><br><span class="line">    <span class="comment">// If you wanted to encrypt it, you can simply set this jwt as the payload</span></span><br><span class="line">    <span class="comment">// of a JsonWebEncryption object and set the cty (Content Type) header to "jwt".</span></span><br><span class="line">    String jwt = jws.getCompactSerialization();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Now you can do something with the JWT. Like send it to some other party</span></span><br><span class="line">    <span class="comment">// over the clouds and through the interwebs.</span></span><br><span class="line">    System.out.println(<span class="string">"JWT: "</span> + jwt);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Use JwtConsumerBuilder to construct an appropriate JwtConsumer, which will</span></span><br><span class="line">    <span class="comment">// be used to validate and process the JWT.</span></span><br><span class="line">    <span class="comment">// The specific validation requirements for a JWT are context dependent, however,</span></span><br><span class="line">    <span class="comment">// it typically advisable to require a (reasonable) expiration time, a trusted issuer, and</span></span><br><span class="line">    <span class="comment">// and audience that identifies your system as the intended recipient.</span></span><br><span class="line">    <span class="comment">// If the JWT is encrypted too, you need only provide a decryption key or</span></span><br><span class="line">    <span class="comment">// decryption key resolver to the builder.</span></span><br><span class="line">    JwtConsumer jwtConsumer = <span class="keyword">new</span> JwtConsumerBuilder()</span><br><span class="line">            .setRequireExpirationTime() <span class="comment">// the JWT must have an expiration time</span></span><br><span class="line">            .setAllowedClockSkewInSeconds(<span class="number">30</span>) <span class="comment">// allow some leeway in validating time based claims to account for clock skew</span></span><br><span class="line">            .setRequireSubject() <span class="comment">// the JWT must have a subject claim</span></span><br><span class="line">            .setExpectedIssuer(<span class="string">"Issuer"</span>) <span class="comment">// whom the JWT needs to have been issued by</span></span><br><span class="line">            .setExpectedAudience(<span class="string">"Audience"</span>) <span class="comment">// to whom the JWT is intended for</span></span><br><span class="line">            .setVerificationKey(rsaJsonWebKey.getKey()) <span class="comment">// verify the signature with the public key</span></span><br><span class="line">            .setJwsAlgorithmConstraints( <span class="comment">// only allow the expected signature algorithm(s) in the given context</span></span><br><span class="line">                    AlgorithmConstraints.ConstraintType.PERMIT, AlgorithmIdentifiers.RSA_USING_SHA256) <span class="comment">// which is only RS256 here</span></span><br><span class="line">            .build(); <span class="comment">// create the JwtConsumer instance</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//  Validate the JWT and process it to the Claims</span></span><br><span class="line">        JwtClaims jwtClaims = jwtConsumer.processToClaims(jwt);</span><br><span class="line">        System.out.println(<span class="string">"JWT validation succeeded! "</span> + jwtClaims);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (InvalidJwtException e)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// InvalidJwtException will be thrown, if the JWT failed processing or validation in anyway.</span></span><br><span class="line">        <span class="comment">// Hopefully with meaningful explanations(s) about what went wrong.</span></span><br><span class="line">        System.out.println(<span class="string">"Invalid JWT! "</span> + e);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Programmatic access to (some) specific reasons for JWT invalidity is also possible</span></span><br><span class="line">        <span class="comment">// should you want different error handling behavior for certain conditions.</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// Whether or not the JWT has expired being one common reason for invalidity</span></span><br><span class="line">        <span class="keyword">if</span> (e.hasExpired())</span><br><span class="line">        &#123;</span><br><span class="line">            System.out.println(<span class="string">"JWT expired at "</span> + e.getJwtContext().getJwtClaims().getExpirationTime());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Or maybe the audience was invalid</span></span><br><span class="line">        <span class="keyword">if</span> (e.hasErrorCode(ErrorCodes.AUDIENCE_INVALID))</span><br><span class="line">        &#123;</span><br><span class="line">            System.out.println(<span class="string">"JWT had wrong audience: "</span> + e.getJwtContext().getJwtClaims().getAudience());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>运行下 控制台输出为：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">JWT: eyJraWQiOiJrMSIsImFsZyI6IlJTMjU2In0.eyJpc3MiOiJJc3N1ZXIiLCJhdWQiOiJBdWRpZW5jZSIsImV4cCI6MTYwOTAzMzExOSwianRpIjoiczlLa2hzMEZpOTU1QjNWaW0tZkV1dyIsImlhdCI6MTYwOTAzMjUxOSwibmJmIjoxNjA5MDMyMzk5LCJzdWIiOiJzdWJqZWN0IiwiZW1haWwiOiJtYWlsQGV4YW1wbGUuY29tIiwiZ3JvdXBzIjpbImdyb3VwLW9uZSIsIm90aGVyLWdyb3VwIiwiZ3JvdXAtdGhyZWUiXX0.ag7oSV0pW6z0N8YmDEfEoXyZWgycSLHsbMjP46dH0cbpamI5cW7jdYHAom-LPviIvTE8k5raWJktgYu0s5vxMzJON95vzQvsxzHVS0kSrKOUZVONRWn4M7mZa56gV9wVYFlcisF-hejNDS-vV7gJN5HEGaU8iiLyYFtSXEftSIj_kbKALCswWc1cRKfJOVnLhMy4xEM3VXevcsRWpOVtt_-h_C4wEzdRPvnuqMKUZwjVwiKV8VDbTnuQCPn9fQ8OThjSZ4lMhTNI2bgls0uglEeEOL5iFGW_orzSv0trW2FbENlwAi41RjIpi3_ga3wPQUPzi6-Pf6YrM5rVVZ3xKg</span><br><span class="line">JWT validation succeeded! JWT Claims Set:&#123;iss=Issuer, aud=Audience, exp=1609033119, jti=s9Kkhs0Fi955B3Vim-fEuw, iat=1609032519, nbf=1609032399, sub=subject, email=mail@example.com, groups=[group-one, other-group, group-three]&#125;</span><br></pre></td></tr></table></figure>

<h4 id="springboot-集成-shiro"><a href="#springboot-集成-shiro" class="headerlink" title="springboot 集成 shiro"></a>springboot 集成 shiro</h4><p><strong>吐槽</strong> ：去 shiro 官网查看文档，没有看到 springboot 相关的内容，最接近的也只是 Java web app 的文档。然后百度了大量的博客。发现了 shiro 的启动器。然后去 maven 仓库查 shiro 的启动器。但是不知道怎么用。<img data-src="https://gitee.com/wu_zhiyong/pic-bed/raw/master/img/image-20201227121931090.png" alt="image-20201227121931090"></p>
<p>难道别人家的 springboot 的例子配置都是自己看源码得出的么。然后继续百度。终于有人说到了。</p>
<p><img data-src="https://gitee.com/wu_zhiyong/pic-bed/raw/master/img/image-20201227122120935.png" alt="image-20201227122120935"></p>
<h5 id="传统web方式（前后端不分离）"><a href="#传统web方式（前后端不分离）" class="headerlink" title="传统web方式（前后端不分离）"></a>传统web方式（前后端不分离）</h5><ul>
<li><p>shiro pom 依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.shiro<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>shiro-spring-boot-web-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">version</span>&gt;</span>1.7.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>application.properties</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#启用/禁用 shiro starter 默认 true</span></span><br><span class="line"><span class="meta">shiro.web.enabled</span>=<span class="string">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#这里如果配置了 url 。</span></span><br><span class="line"><span class="comment"># shiro 的认证 filter 会自动将 post /login 的请求视作登录 并从请求中获取参数 来执行 shiro 的 login 逻辑。</span></span><br><span class="line"><span class="comment"># 且 shiro 会将 get /login 视作获取登录页面。当未认证的请求被拦截后 shiro 会重定向到 get /login.</span></span><br><span class="line"><span class="comment"># 注意：如果没配置 loginUrl 那么 shiro 会默认把 get /login.jsp 路径当作登录页（即认证失败会往这里跳转让你去登录）</span></span><br><span class="line"><span class="comment"># 相关源代码 参看 FormAuthenticationFilter.onAccessDenied() 方法。</span></span><br><span class="line"><span class="comment">#shiro.loginUrl=/login</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#如果配置了此参数。shiro 的认证 filter 在处理成功登录后会跳转到这里的url。</span></span><br><span class="line"><span class="comment">#注意：shiro 会记住上次登录的地址。如果有上次访问的地址 那么会重定向上次的地址。</span></span><br><span class="line"><span class="comment"># 相关源代码 参看 FormAuthenticationFilter.onLoginSuccess() </span></span><br><span class="line"><span class="comment">#shiro.successUrl=/success</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>ShiroConfig.class</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wzy.platform.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.authc.credential.HashedCredentialsMatcher;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.realm.Realm;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.spring.web.config.DefaultShiroFilterChainDefinition;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.spring.web.config.ShiroFilterChainDefinition;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.web.mgt.DefaultWebSecurityManager;</span><br><span class="line"><span class="keyword">import</span> org.springframework.aop.framework.autoproxy.DefaultAdvisorAutoProxyCreator;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span> ShiroConfig</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span> wuzhiyong</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span> 2020/12/27 12:26</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Version</span> 1.0</span></span><br><span class="line"><span class="comment"> **/</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ShiroConfig</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 配置密码加密 规则</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> HashedCredentialsMatcher <span class="title">hashedCredentialsMatcher</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        HashedCredentialsMatcher hashedCredentialsMatcher = <span class="keyword">new</span> HashedCredentialsMatcher();</span><br><span class="line">        <span class="comment">//md5加密1次</span></span><br><span class="line">        hashedCredentialsMatcher.setHashAlgorithmName(<span class="string">"md5"</span>);</span><br><span class="line">        hashedCredentialsMatcher.setHashIterations(<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">return</span> hashedCredentialsMatcher;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Realm <span class="title">realm</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        ShiroCustomRealm customRealm = <span class="keyword">new</span> ShiroCustomRealm();</span><br><span class="line">        customRealm.setCredentialsMatcher(hashedCredentialsMatcher());</span><br><span class="line">        <span class="keyword">return</span> customRealm;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> DefaultWebSecurityManager <span class="title">securityManager</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        DefaultWebSecurityManager securityManager = <span class="keyword">new</span> DefaultWebSecurityManager();</span><br><span class="line">        securityManager.setRealm(realm());</span><br><span class="line">        <span class="keyword">return</span> securityManager;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ShiroFilterChainDefinition <span class="title">shiroFilterChainDefinition</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        DefaultShiroFilterChainDefinition chainDefinition = <span class="keyword">new</span> DefaultShiroFilterChainDefinition();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        chainDefinition.addPathDefinition(<span class="string">"/static/**"</span>, <span class="string">"anon"</span>);</span><br><span class="line">        chainDefinition.addPathDefinition(<span class="string">"/login"</span>, <span class="string">"anon"</span>);</span><br><span class="line">      <span class="comment">//      其他的权限这里我们都通过注解的方式来控制</span></span><br><span class="line">          <span class="comment">// logged in users with the 'admin' role</span></span><br><span class="line"><span class="comment">//        chainDefinition.addPathDefinition("/admin/**", "authc, roles[admin]");</span></span><br><span class="line"><span class="comment">//        // logged in users with the 'document:read' permission</span></span><br><span class="line"><span class="comment">//        chainDefinition.addPathDefinition("/docs/**", "authc, perms[document:read]");</span></span><br><span class="line">      </span><br><span class="line"><span class="comment">//        chainDefinition.addPathDefinition("/logout", "authc");</span></span><br><span class="line"><span class="comment">//        chainDefinition.addPathDefinition("/**", "anon");</span></span><br><span class="line">        <span class="keyword">return</span> chainDefinition;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> DefaultAdvisorAutoProxyCreator <span class="title">getDefaultAdvisorAutoProxyCreator</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        DefaultAdvisorAutoProxyCreator creator = <span class="keyword">new</span> DefaultAdvisorAutoProxyCreator();</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * setUsePrefix(false)用于解决一个奇怪的bug。在引入spring aop的情况下。</span></span><br><span class="line"><span class="comment">         * 在<span class="doctag">@Controller</span>注解的类的方法中加入<span class="doctag">@RequiresRole</span>注解，会导致该方法无法映射请求，导致返回404。</span></span><br><span class="line"><span class="comment">         * 加入这项配置能解决这个bug</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        creator.setUsePrefix(<span class="keyword">true</span>);</span><br><span class="line">        <span class="keyword">return</span> creator;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>ShiroCustomRealm.class</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wzy.platform.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.wzy.platform.model.SysUser;</span><br><span class="line"><span class="keyword">import</span> com.wzy.platform.service.SysPermissionService;</span><br><span class="line"><span class="keyword">import</span> com.wzy.platform.service.SysRoleService;</span><br><span class="line"><span class="keyword">import</span> com.wzy.platform.service.SysUserService;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.authc.*;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.authz.AuthorizationInfo;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.authz.SimpleAuthorizationInfo;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.realm.AuthorizingRealm;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.subject.PrincipalCollection;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.util.ByteSource;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span> ShiroCustomRealm</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span> wuzhiyong</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span> 2020/12/28 8:40</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Version</span> 1.0</span></span><br><span class="line"><span class="comment"> **/</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ShiroCustomRealm</span> <span class="keyword">extends</span> <span class="title">AuthorizingRealm</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger LOGGER = LoggerFactory.getLogger(ShiroCustomRealm<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> SysUserService sysUserService;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> SysPermissionService sysPermissionService;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> SysRoleService sysRoleService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> AuthorizationInfo <span class="title">doGetAuthorizationInfo</span><span class="params">(PrincipalCollection principals)</span> </span>&#123;</span><br><span class="line">        SysUser sysUser = (SysUser) principals.getPrimaryPrincipal();</span><br><span class="line">      	<span class="comment">//查询 权限 </span></span><br><span class="line">        List&lt;String&gt; sysPermissions = sysPermissionService.selectPermissionByUserId(sysUser.getUserId());</span><br><span class="line">        <span class="comment">//查询 角色</span></span><br><span class="line">        List&lt;String&gt; sysRoles = sysRoleService.selectRolesByUserId(sysUser.getUserId());</span><br><span class="line">        SimpleAuthorizationInfo info = <span class="keyword">new</span> SimpleAuthorizationInfo();</span><br><span class="line">        info.addStringPermissions(sysPermissions);</span><br><span class="line">        info.addRoles(sysRoles);</span><br><span class="line">        LOGGER.info(<span class="string">"doGetAuthorizationInfo"</span>);</span><br><span class="line">        <span class="keyword">return</span> info;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> AuthenticationInfo <span class="title">doGetAuthenticationInfo</span><span class="params">(AuthenticationToken authenticationToken)</span> <span class="keyword">throws</span> AuthenticationException </span>&#123;</span><br><span class="line">        UsernamePasswordToken token = (UsernamePasswordToken) authenticationToken;</span><br><span class="line">        <span class="comment">//通过 用户名 查询用户对象</span></span><br><span class="line">      	SysUser sysUser = sysUserService.findByUserName(token.getUsername());</span><br><span class="line">        <span class="keyword">if</span> (sysUser == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        LOGGER.info(<span class="string">"doGetAuthenticationInfo"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> SimpleAuthenticationInfo(sysUser, sysUser.getPassword().toCharArray(), ByteSource.Util.bytes(sysUser.getSalt()), getName());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>LoginController.class</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wzy.platform.web.mvc;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.SecurityUtils;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.authc.DisabledAccountException;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.authc.IncorrectCredentialsException;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.authc.UnknownAccountException;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.authc.UsernamePasswordToken;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.authz.annotation.RequiresAuthentication;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.subject.Subject;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Controller;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ui.Model;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PostMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ResponseBody;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span> LoginController</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span> wuzhiyong</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span> 2020/12/28 22:26</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Version</span> 1.0</span></span><br><span class="line"><span class="comment"> **/</span></span><br><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LoginController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(&#123;<span class="string">"/"</span>,<span class="string">"/index"</span>&#125;)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">index</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"index"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/success"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">success</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"success"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * get请求，登录页面跳转</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/login"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">login</span><span class="params">(Model model)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//如果已经认证通过，直接跳转到首页</span></span><br><span class="line">        <span class="keyword">if</span> (SecurityUtils.getSubject().isAuthenticated()) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"redirect:/index"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        model.addAttribute(<span class="string">"message"</span>,<span class="string">"wuzhiyong"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"login"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * post表单提交，登录</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> username</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> password</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> model</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@PostMapping</span>(<span class="string">"/login"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">login</span><span class="params">(String username, String password, Model model)</span> </span>&#123;</span><br><span class="line">        Subject user = SecurityUtils.getSubject();</span><br><span class="line">        UsernamePasswordToken token = <span class="keyword">new</span> UsernamePasswordToken(username, password);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//shiro帮我们匹配密码什么的，我们只需要把东西传给它，它会根据我们在UserRealm里认证方法设置的来验证</span></span><br><span class="line">            user.login(token);</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"redirect:/success"</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (UnknownAccountException e) &#123;</span><br><span class="line">            <span class="comment">//账号不存在和下面密码错误一般都合并为一个账号或密码错误，这样可以增加暴力破解难度</span></span><br><span class="line">            model.addAttribute(<span class="string">"message"</span>, <span class="string">"账号不存在！"</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (DisabledAccountException e) &#123;</span><br><span class="line">            model.addAttribute(<span class="string">"message"</span>, <span class="string">"账号未启用！"</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IncorrectCredentialsException e) &#123;</span><br><span class="line">            model.addAttribute(<span class="string">"message"</span>, <span class="string">"密码错误！"</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">            model.addAttribute(<span class="string">"message"</span>, <span class="string">"未知错误！"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"success"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 退出</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RequiresAuthentication</span></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/logout"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">logout</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        SecurityUtils.getSubject().logout();</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"redirect:/login"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<p><strong>三个简单页面：</strong></p>
<ul>
<li><p>index.html</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>index<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">index page</span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>login.html</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span> <span class="attr">xmlns:th</span>=<span class="string">"http://www.w3.org/1999/xhtml"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Title<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span> <span class="attr">th:text</span>=<span class="string">"$&#123;message&#125;"</span>&gt;</span>$&#123;message&#125;<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">method</span>=<span class="string">"post"</span> <span class="attr">action</span>=<span class="string">"/login"</span>&gt;</span></span><br><span class="line">    用户名：<span class="tag">&lt;<span class="name">input</span> <span class="attr">name</span>=<span class="string">"username"</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">    密码：<span class="tag">&lt;<span class="name">input</span> <span class="attr">name</span>=<span class="string">"password"</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"submit"</span> <span class="attr">value</span>=<span class="string">"登录"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>success.html</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>test success<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"> test success!</span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

</li>
</ul>
<p><strong>权限注解</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wzy.platform.web.rest;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.wzy.platform.service.UserService;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.authz.annotation.*;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span> UserController</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span> wuzhiyong</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span> 2020/12/6 15:05</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Version</span> 1.0</span></span><br><span class="line"><span class="comment"> **/</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/user"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Logger log = LoggerFactory.getLogger(<span class="keyword">this</span>.getClass());</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    UserService userService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/test"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">testUser</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> userService.list();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 需要 登录  才能访问的</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RequiresAuthentication</span></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/requiresAuthentication"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">requiresAuthentication</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"RequiresAuthentication"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 游客访问的</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RequiresGuest</span></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/requiresGuest"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">requiresGuest</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"RequiresGuest"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 需要 xx权限 才能访问的</span></span><br><span class="line"><span class="comment">     * logical 参数 表示多个权限（角色）之间的逻辑关系，默认为 AND </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RequiresPermissions</span>(<span class="string">"m@sys:role"</span>)</span><br><span class="line"><span class="comment">//    @RequiresPermissions(value = "m@sys:role")</span></span><br><span class="line"><span class="comment">//    @RequiresPermissions(value = &#123;"m@sys:role","m@sys:usr"&#125;)</span></span><br><span class="line"><span class="comment">//    @RequiresPermissions(value = &#123;"m@sys:role","m@sys:usr"&#125;,logical = Logical.OR)</span></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/requiresPermissions"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">requiresPermissions</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"RequiresPermissions"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 需要 xx角色才能访问的</span></span><br><span class="line"><span class="comment">     * logical 参数 表示多个权限（角色）之间的逻辑关系，默认为 AND </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RequiresRoles</span>(<span class="string">"普通用户"</span>)</span><br><span class="line"><span class="comment">//    @RequiresRoles(value = "普通用户")</span></span><br><span class="line"><span class="comment">//    @RequiresRoles(value = &#123;"普通用户","用户管理员"&#125;)</span></span><br><span class="line"><span class="comment">//    @RequiresRoles(value = &#123;"普通用户","用户管理员"&#125;,logical = Logical.OR)</span></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/requiresRoles"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">requiresRoles</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"RequiresRoles"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 需要 xx角色 和 xx权限 才能访问的</span></span><br><span class="line"><span class="comment">     * Shiro的认证注解处理是有内定的处理顺序的，如果有多个注解的话，前面的通过了会继续检查后面的，</span></span><br><span class="line"><span class="comment">     	 若不通过则直接返回，处理顺序依次为（与实际声明顺序无关）：</span></span><br><span class="line"><span class="comment">     *      RequiresRoles</span></span><br><span class="line"><span class="comment">     *      RequiresPermissions</span></span><br><span class="line"><span class="comment">     *      RequiresAuthentication</span></span><br><span class="line"><span class="comment">     *      RequiresUser</span></span><br><span class="line"><span class="comment">     *      RequiresGuest</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RequiresPermissions</span>(value = &#123;<span class="string">"m@sys:role"</span>,<span class="string">"m@sys:usr"</span>&#125;,logical = Logical.OR)</span><br><span class="line">    <span class="meta">@RequiresRoles</span>(<span class="string">"普通用户"</span>)</span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/requiresRolesPermissions"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">requiresRolesPermissions</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"RequiresRoles"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 需要 登录 或 ‘记住我’ 才能访问的</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RequiresUser</span></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/requiresUser"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">requiresUser</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"RequiresUser"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>用户与密码</strong></p>
<table>
<thead>
<tr>
<th>id</th>
<th>user_name</th>
<th>full_name</th>
<th>password</th>
<th>salt</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>zhangsan</td>
<td>张三</td>
<td>86fb1b048301461bdc71d021d2af3f97</td>
<td>1</td>
</tr>
<tr>
<td>2</td>
<td>lisi</td>
<td>李四</td>
<td>c9351e5cf153923f052ebe1462cca93a</td>
<td>2</td>
</tr>
<tr>
<td>3</td>
<td>wangwu</td>
<td>王五</td>
<td>92262648696eae1b0a321cbd2b238bf2</td>
<td>3</td>
</tr>
<tr>
<td>4</td>
<td>user1</td>
<td>用户1</td>
<td>86fb1b048301461bdc71d021d2af3f97</td>
<td>4</td>
</tr>
</tbody></table>
<p>密码可通过如下方法加密：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.shiro.crypto.hash.SimpleHash;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.util.ByteSource;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.test.context.SpringBootTest;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line">  </span><br><span class="line"> 	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    	<span class="comment">//参数1:md5 方式</span></span><br><span class="line">    	<span class="comment">//参数2：密码</span></span><br><span class="line">    	<span class="comment">//参数3：盐</span></span><br><span class="line">    	<span class="comment">//参数4：加密次数</span></span><br><span class="line">			SimpleHash simpleHash = <span class="keyword">new</span> SimpleHash(<span class="string">"md5"</span>,<span class="string">"zhangsan"</span>.toCharArray(), ByteSource.Util.bytes(<span class="string">"1"</span>),<span class="number">1</span>);</span><br><span class="line">			System.out.println(simpleHash.toHex());</span><br><span class="line">	&#125; </span><br><span class="line">  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>优化</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.apache.shiro.web.util;	</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebUtils</span> </span>&#123;</span><br><span class="line">		<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">redirectToSavedRequest</span><span class="params">(ServletRequest request, ServletResponse response, String fallbackUrl)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        String successUrl = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">boolean</span> contextRelative = <span class="keyword">true</span>;</span><br><span class="line">        SavedRequest savedRequest = WebUtils.getAndClearSavedRequest(request);</span><br><span class="line">        <span class="keyword">if</span> (savedRequest != <span class="keyword">null</span> &amp;&amp; savedRequest.getMethod().equalsIgnoreCase(AccessControlFilter.GET_METHOD)) &#123;</span><br><span class="line">            successUrl = savedRequest.getRequestUrl();</span><br><span class="line">            contextRelative = <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (successUrl == <span class="keyword">null</span>) &#123;</span><br><span class="line">            successUrl = fallbackUrl;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (successUrl == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Success URL not available via saved request or via the "</span> +</span><br><span class="line">                    <span class="string">"successUrlFallback method parameter. One of these must be non-null for "</span> +</span><br><span class="line">                    <span class="string">"issueSuccessRedirect() to work."</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        WebUtils.issueRedirect(request, response, successUrl, <span class="keyword">null</span>, contextRelative);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="番外篇（简化代码）"><a href="#番外篇（简化代码）" class="headerlink" title="番外篇（简化代码）"></a>番外篇（简化代码）</h5><p>如果我们的登录方式只是 用户名/密码 的方式登录的话。我们可以简化一部分代码。细心的同学是可以从上面的 application.properties 代码中看出一些端倪。</p>
<p>首先配置：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">shiro.loginUrl</span>=<span class="string">/login</span></span><br></pre></td></tr></table></figure>

<p>ShiroConfig 中去除这段代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chainDefinition.addPathDefinition(<span class="string">"/login"</span>, <span class="string">"anon"</span>);</span><br></pre></td></tr></table></figure>

<p>LoginController  中注释掉这段代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * post表单提交，登录</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> username</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> password</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> model</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@PostMapping</span>(<span class="string">"/login"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">login</span><span class="params">(String username, String password, Model model)</span> </span>&#123;</span><br><span class="line">    Subject user = SecurityUtils.getSubject();</span><br><span class="line">    UsernamePasswordToken token = <span class="keyword">new</span> UsernamePasswordToken(username, password);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//shiro帮我们匹配密码什么的，我们只需要把东西传给它，它会根据我们在UserRealm里认证方法设置的来验证</span></span><br><span class="line">        user.login(token);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"redirect:/success"</span>;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (UnknownAccountException e) &#123;</span><br><span class="line">        <span class="comment">//账号不存在和下面密码错误一般都合并为一个账号或密码错误，这样可以增加暴力破解难度</span></span><br><span class="line">        model.addAttribute(<span class="string">"message"</span>, <span class="string">"账号不存在！"</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (DisabledAccountException e) &#123;</span><br><span class="line">        model.addAttribute(<span class="string">"message"</span>, <span class="string">"账号未启用！"</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IncorrectCredentialsException e) &#123;</span><br><span class="line">        model.addAttribute(<span class="string">"message"</span>, <span class="string">"密码错误！"</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">        model.addAttribute(<span class="string">"message"</span>, <span class="string">"未知错误！"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"login"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>好了，我们要登录的时候，直接请求 post /login  传上 username/password  就可以了。</p>
<hr>
<p>原因就是利用 shiro 自带的认证逻辑 ：源码  FormAuthenticationFilter.onAccessDenied</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">onAccessDenied</span><span class="params">(ServletRequest request, ServletResponse response)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (isLoginRequest(request, response)) &#123;</span><br><span class="line">          <span class="keyword">if</span> (isLoginSubmission(request, response)) &#123;</span><br><span class="line">              <span class="keyword">if</span> (log.isTraceEnabled()) &#123;</span><br><span class="line">                  log.trace(<span class="string">"Login submission detected.  Attempting to execute login."</span>);</span><br><span class="line">              &#125;</span><br><span class="line">              <span class="keyword">return</span> executeLogin(request, response);</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">              <span class="keyword">if</span> (log.isTraceEnabled()) &#123;</span><br><span class="line">                  log.trace(<span class="string">"Login page view."</span>);</span><br><span class="line">              &#125;</span><br><span class="line">              <span class="comment">//allow them to see the login page ;)</span></span><br><span class="line">              <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">          &#125;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="keyword">if</span> (log.isTraceEnabled()) &#123;</span><br><span class="line">              log.trace(<span class="string">"Attempting to access a path which requires authentication.  Forwarding to the "</span> +</span><br><span class="line">                      <span class="string">"Authentication url ["</span> + getLoginUrl() + <span class="string">"]"</span>);</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          saveRequestAndRedirectToLogin(request, response);</span><br><span class="line">          <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p><strong>注意</strong> 由于 shiro 中在 request 中获取 用户名/密码  是固定的参数 uaername/password 。所以我们登录携带参数的 key 必须为：username 和 password  在源码中就可以看到：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FormAuthenticationFilter</span> <span class="keyword">extends</span> <span class="title">AuthenticatingFilter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//TODO - complete JavaDoc</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String DEFAULT_ERROR_KEY_ATTRIBUTE_NAME = <span class="string">"shiroLoginFailure"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String DEFAULT_USERNAME_PARAM = <span class="string">"username"</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String DEFAULT_PASSWORD_PARAM = <span class="string">"password"</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String DEFAULT_REMEMBER_ME_PARAM = <span class="string">"rememberMe"</span>;</span><br><span class="line">  </span><br><span class="line">  ......</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="springboot-集成-shiro-jwt-前后端分离"><a href="#springboot-集成-shiro-jwt-前后端分离" class="headerlink" title="springboot 集成 shiro + jwt (前后端分离)"></a>springboot 集成 shiro + jwt (前后端分离)</h4><p>我们一边根据请求的过程一边来贴配置代码。</p>
<ul>
<li><p>登录部分</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * post表单提交，登录</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> username</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> password</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> model</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@PostMapping</span>(<span class="string">"/login"</span>)</span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">login</span><span class="params">(HttpServletRequest request, String username, String password, Model model)</span> <span class="keyword">throws</span> JoseException </span>&#123;</span><br><span class="line"><span class="comment">//        SysUser user = sysUserService.findByUserNameAndPwd(username,simpleHash.toString());</span></span><br><span class="line">        SysUser user = sysUserService.findByUserName(username);</span><br><span class="line">        <span class="keyword">if</span> (user == <span class="keyword">null</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> ApiResult.fail(<span class="string">"用户名错误！"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        SimpleHash simpleHash = <span class="keyword">new</span> SimpleHash(<span class="string">"md5"</span>,password.toCharArray(), ByteSource.Util.bytes(user.getSalt()),<span class="number">1</span>);</span><br><span class="line">        System.out.println(simpleHash);</span><br><span class="line">        System.out.println(user.getPassword());</span><br><span class="line">        <span class="keyword">if</span> (simpleHash.toString().equals(user.getPassword()))&#123;</span><br><span class="line">          <span class="comment">//签发 jwt 并返回</span></span><br><span class="line">            <span class="keyword">return</span> ApiResult.ok(JwtUtils.getInstance().create(user));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> ApiResult.fail(<span class="string">"用户名或密码错误！"</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>登录成功返回一个 jwt 串。前端拿到后请求其它接口带上 jwt 即可。</p>
</li>
<li><p>过滤器部分</p>
<p>当请求路径被拦截后，来到这个过滤器</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.wzy.platform.common.ApiResult;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.lang.StringUtils;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.authc.AuthenticationException;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.subject.Subject;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.web.filter.authc.PassThruAuthenticationFilter;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.web.util.WebUtils;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletResponse;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span> ShiroCustomFilter</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span> wuzhiyong</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span> 2021/1/15 13:33</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Version</span> 1.0</span></span><br><span class="line"><span class="comment"> **/</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ShiroCustomJwtFilter</span> <span class="keyword">extends</span> <span class="title">PassThruAuthenticationFilter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;custom-web-auth-token-name&#125;"</span>)</span><br><span class="line">    String tokenName;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">onAccessDenied</span><span class="params">(ServletRequest request, ServletResponse response)</span> </span>&#123;</span><br><span class="line"><span class="comment">//        if (isLoginRequest(request, response)) &#123;</span></span><br><span class="line"><span class="comment">//            if (isLoginSubmission(request, response)) &#123;</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//            &#125;</span></span><br><span class="line"><span class="comment">//            return true;</span></span><br><span class="line"><span class="comment">//        &#125;</span></span><br><span class="line"></span><br><span class="line">        String jwt = getJwt(request);</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isBlank(jwt))&#123;</span><br><span class="line">            <span class="comment">//todo 返回错误码</span></span><br><span class="line">            ApiResult.writeToJson(response, ApiResult.fail(<span class="string">"请登录！"</span>));</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        ShiroCustomJwtToken token = <span class="keyword">new</span> ShiroCustomJwtToken(jwt);</span><br><span class="line">        Subject subject = getSubject(request, response);</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            subject.login(token);</span><br><span class="line">        &#125;<span class="keyword">catch</span> (AuthenticationException e)&#123;</span><br><span class="line">            ApiResult.writeToJson(response, ApiResult.fail(<span class="string">"身份认证失败！请重新登录。"</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function">String <span class="title">getJwt</span><span class="params">(ServletRequest request)</span> </span>&#123;</span><br><span class="line">        HttpServletRequest httpServletRequest = (HttpServletRequest) request;</span><br><span class="line">        <span class="comment">//从header中获取token</span></span><br><span class="line">        String token = httpServletRequest.getHeader(<span class="string">"token"</span>);</span><br><span class="line">        <span class="comment">//如果header中不存在token，则从参数中获取token</span></span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isBlank(token)) &#123;</span><br><span class="line">            token = httpServletRequest.getParameter(<span class="string">"token"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> token;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">isLoginSubmission</span><span class="params">(ServletRequest request, ServletResponse response)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> (request <span class="keyword">instanceof</span> HttpServletRequest) &amp;&amp; WebUtils.toHttp(request).getMethod().equalsIgnoreCase(POST_METHOD);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>逻辑上 先判断请求中有没有 jwt 没有就返回 提示：”身份认证失败！请重新登录。”。如果有，那么就 把 jwt 使用 ShiroCustomJwtToken 包装后执行 shiro 的认证逻辑  subject.login(token);</p>
</li>
<li><p>自定义 Realm 部分</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.wzy.platform.common.utils.JwtUtils;</span><br><span class="line"><span class="keyword">import</span> com.wzy.platform.service.SysPermissionService;</span><br><span class="line"><span class="keyword">import</span> com.wzy.platform.service.SysRoleService;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.authc.AuthenticationException;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.authc.AuthenticationInfo;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.authc.AuthenticationToken;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.authc.SimpleAuthenticationInfo;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.authz.AuthorizationException;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.authz.AuthorizationInfo;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.authz.SimpleAuthorizationInfo;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.realm.AuthorizingRealm;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.subject.PrincipalCollection;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.subject.SimplePrincipalCollection;</span><br><span class="line"><span class="keyword">import</span> org.jose4j.jwt.MalformedClaimException;</span><br><span class="line"><span class="keyword">import</span> org.jose4j.lang.JoseException;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span> ShiroCustomJwtRealm</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span> wuzhiyong</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span> 2021/1/25 9:32</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Version</span> 1.0</span></span><br><span class="line"><span class="comment"> **/</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ShiroCustomJwtRealm</span> <span class="keyword">extends</span> <span class="title">AuthorizingRealm</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger LOGGER = LoggerFactory.getLogger(ShiroCustomRealm<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> SysPermissionService sysPermissionService;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> SysRoleService sysRoleService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> AuthorizationInfo <span class="title">doGetAuthorizationInfo</span><span class="params">(PrincipalCollection principals)</span> </span>&#123;</span><br><span class="line">        java.lang.String jwt = (java.lang.String) principals.getPrimaryPrincipal();</span><br><span class="line">        Long id = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            JwtUtils.getInstance().validateJwt(jwt);</span><br><span class="line">            id = Long.valueOf(JwtUtils.getInstance().getSubject(jwt));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (MalformedClaimException | JoseException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line"><span class="comment">//            有可能 认证的时候 jwt 有效， 这里授权的时候 jwt 过期失效了。</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> AuthorizationException(<span class="string">"method AuthorizationInfo。get permissions or roles Exception in jwt"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        SimpleAuthorizationInfo info = <span class="keyword">new</span> SimpleAuthorizationInfo();</span><br><span class="line">        info.addStringPermissions(sysPermissionService.selectPermissionByUserId(id));</span><br><span class="line">        info.addRoles(sysRoleService.selectRolesByUserId(id));</span><br><span class="line">        LOGGER.info(<span class="string">"doGetAuthorizationInfo"</span>);</span><br><span class="line">        <span class="keyword">return</span> info;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> AuthenticationInfo <span class="title">doGetAuthenticationInfo</span><span class="params">(AuthenticationToken authenticationToken)</span> <span class="keyword">throws</span> AuthenticationException </span>&#123;</span><br><span class="line">        ShiroCustomJwtToken token = (ShiroCustomJwtToken) authenticationToken;</span><br><span class="line">        LOGGER.info(<span class="string">"doGetAuthenticationInfo"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> SimpleAuthenticationInfo(<span class="keyword">new</span> SimplePrincipalCollection(token.getPrincipal(),token.getPrincipal().toString()),token.getCredentials());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">supports</span><span class="params">(AuthenticationToken token)</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> token <span class="keyword">instanceof</span> ShiroCustomJwtToken;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Realm 的逻辑都一样 doGetAuthorizationInfo 这里拿出 jwt 后解析出 用户 id 然后再从数据库里查出角色和权限放入 SimpleAuthorizationInfo 中。doGetAuthenticationInfo 则是取出 jwt 并放入 SimpleAuthenticationInfo</p>
</li>
<li><p>自定义 token</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.authc.AuthenticationToken;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span> ShiroCustomJwtToken</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span> wuzhiyong</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span> 2021/1/25 9:33</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Version</span> 1.0</span></span><br><span class="line"><span class="comment"> **/</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ShiroCustomJwtToken</span> <span class="keyword">implements</span> <span class="title">AuthenticationToken</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    String jwt;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ShiroCustomJwtToken</span><span class="params">(String jwt)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.jwt = jwt;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">getPrincipal</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> jwt;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">getCredentials</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> jwt;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>自定义 jwt 密码验证器</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.wzy.platform.common.utils.JwtUtils;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.authc.AuthenticationInfo;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.authc.AuthenticationToken;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.authc.credential.CredentialsMatcher;</span><br><span class="line"><span class="keyword">import</span> org.jose4j.lang.JoseException;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span> ShiroCustomJwtCredentialsMatcher</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span> wuzhiyong</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span> 2021/1/25 10:04</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Version</span> 1.0</span></span><br><span class="line"><span class="comment"> **/</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ShiroCustomJwtCredentialsMatcher</span> <span class="keyword">implements</span> <span class="title">CredentialsMatcher</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">doCredentialsMatch</span><span class="params">(AuthenticationToken token, AuthenticationInfo info)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (JwtUtils.getInstance().validateJwt((String) token.getPrincipal())==<span class="keyword">null</span>)&#123;</span><br><span class="line"><span class="comment">//                throw new AuthenticationException("jwt 验证失败！");</span></span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (JoseException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里只需要通过 jwtUtils 来验证 jwt 就可以了</p>
</li>
<li><p>配置类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.mgt.DefaultSessionStorageEvaluator;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.mgt.DefaultSubjectDAO;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.mgt.SessionStorageEvaluator;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.realm.Realm;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.spring.web.ShiroFilterFactoryBean;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.web.mgt.DefaultWebSecurityManager;</span><br><span class="line"><span class="keyword">import</span> org.springframework.aop.framework.autoproxy.DefaultAdvisorAutoProxyCreator;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.Filter;</span><br><span class="line"><span class="keyword">import</span> java.util.LinkedHashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span> ShiroConfig</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span> wuzhiyong</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span> 2020/12/27 12:26</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Version</span> 1.0</span></span><br><span class="line"><span class="comment"> **/</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ShiroConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Realm <span class="title">realm</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">//jwt realm</span></span><br><span class="line">        ShiroCustomJwtRealm customRealm = <span class="keyword">new</span> ShiroCustomJwtRealm();</span><br><span class="line">      	<span class="comment">//配置 自定义的 jwt 密码验证器</span></span><br><span class="line">        customRealm.setCredentialsMatcher(<span class="keyword">new</span> ShiroCustomJwtCredentialsMatcher());</span><br><span class="line">        customRealm.setCachingEnabled(<span class="keyword">false</span>);</span><br><span class="line">        <span class="keyword">return</span> customRealm;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 注入SessionStorageEvaluator,关闭Session存储</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> SessionStorageEvaluator <span class="title">sessionStorageEvaluator</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        DefaultSessionStorageEvaluator defaultSessionStorageEvaluator = <span class="keyword">new</span> DefaultSessionStorageEvaluator();</span><br><span class="line">        <span class="comment">//关闭会话存贮</span></span><br><span class="line">        defaultSessionStorageEvaluator.setSessionStorageEnabled(<span class="keyword">false</span>);</span><br><span class="line">        <span class="keyword">return</span> defaultSessionStorageEvaluator;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> DefaultWebSecurityManager <span class="title">securityManager</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        DefaultWebSecurityManager securityManager = <span class="keyword">new</span> DefaultWebSecurityManager();</span><br><span class="line">        securityManager.setRealm(realm());</span><br><span class="line">        DefaultSubjectDAO defaultSubjectDAO = <span class="keyword">new</span> DefaultSubjectDAO();</span><br><span class="line">        defaultSubjectDAO.setSessionStorageEvaluator(sessionStorageEvaluator());</span><br><span class="line">        securityManager.setSubjectDAO(defaultSubjectDAO);</span><br><span class="line">        <span class="keyword">return</span> securityManager;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ShiroFilterFactoryBean <span class="title">shiroFilterFactoryBean</span> <span class="params">()</span> </span>&#123;</span><br><span class="line">        ShiroFilterFactoryBean shiroFilterFactoryBean = <span class="keyword">new</span> ShiroFilterFactoryBean();</span><br><span class="line">        shiroFilterFactoryBean.setSecurityManager(securityManager());</span><br><span class="line"><span class="comment">//        shiroFilterFactoryBean.setLoginUrl("/login");</span></span><br><span class="line"><span class="comment">//        shiroFilterFactoryBean.setSuccessUrl("/");</span></span><br><span class="line"><span class="comment">//        shiroFilterFactoryBean.setUnauthorizedUrl("/unauth");</span></span><br><span class="line">        Map&lt;String, Filter&gt; filters = shiroFilterFactoryBean.getFilters();</span><br><span class="line">        <span class="comment">//配置拦截器,实现无权限返回401,而不是跳转到登录页</span></span><br><span class="line">        filters.put(<span class="string">"authc_jwt"</span>, <span class="keyword">new</span> ShiroCustomJwtFilter());</span><br><span class="line"></span><br><span class="line">        <span class="comment">//注意此处使用的是LinkedHashMap，是有顺序的，shiro会按从上到下的顺序匹配验证，匹配了就不再继续验证</span></span><br><span class="line">        <span class="comment">//所以上面的url要苛刻，宽松的url要放在下面，尤其是"/**"要放到最下面，如果放前面的话其后的验证规则就没作用了。</span></span><br><span class="line">        Map&lt;String, String&gt; filterChainDefinitionMap = <span class="keyword">new</span> LinkedHashMap&lt;&gt;();</span><br><span class="line">        filterChainDefinitionMap.put(<span class="string">"/login"</span>, <span class="string">"anon"</span>);</span><br><span class="line">        filterChainDefinitionMap.put(<span class="string">"/static/**"</span>, <span class="string">"anon"</span>);</span><br><span class="line">        filterChainDefinitionMap.put(<span class="string">"/captcha.jpg"</span>, <span class="string">"anon"</span>);</span><br><span class="line">        filterChainDefinitionMap.put(<span class="string">"/favicon.ico"</span>, <span class="string">"anon"</span>);</span><br><span class="line"><span class="comment">//        filterChainDefinitionMap.put("/**", "authc_jwt");</span></span><br><span class="line"></span><br><span class="line">        shiroFilterFactoryBean.setFilterChainDefinitionMap(filterChainDefinitionMap);</span><br><span class="line">        <span class="keyword">return</span> shiroFilterFactoryBean;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> DefaultAdvisorAutoProxyCreator <span class="title">getDefaultAdvisorAutoProxyCreator</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        DefaultAdvisorAutoProxyCreator creator = <span class="keyword">new</span> DefaultAdvisorAutoProxyCreator();</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * setUsePrefix(false)用于解决一个奇怪的bug。在引入spring aop的情况下。</span></span><br><span class="line"><span class="comment">         * 在<span class="doctag">@Controller</span>注解的类的方法中加入<span class="doctag">@RequiresRole</span>注解，会导致该方法无法映射请求，导致返回404。</span></span><br><span class="line"><span class="comment">         * 加入这项配置能解决这个bug</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        creator.setUsePrefix(<span class="keyword">true</span>);</span><br><span class="line">        <span class="keyword">return</span> creator;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>配置完毕！ 使用的时候。接口上加上相关注解就可以了。</p>
</li>
</ul>
<h4 id="异常类"><a href="#异常类" class="headerlink" title="异常类"></a>异常类</h4><p>UnknownAccountException (用户名错误或者不存在)</p>
<p>IncorrectCredentialsException(密码不正确)<br>AuthenticationException 异常是Shiro在登录认证过程中，认证失败需要抛出的异常。</p>
<p>AuthenticationException包含以下子类：</p>
<p>CredentitalsException 凭证异常</p>
<p>IncorrentCredentialsException 不正确的凭证</p>
<p>ExpiredCredentialsException 凭证过期</p>
<p>AccountException 账号异常</p>
<p>ConcurrentAccessException 并发访问异常（多个用户同时登录时抛出）</p>
<p>UnknownAccountException 未知的账号</p>
<p>ExcessiveAttemptsException 认证次数超过限制</p>
<p>DisabledAccountException 禁用的账号</p>
<p>LockedAccountException 账号被锁定<br>UnsupportedTokenException 使用了不支持的Token</p>
<h4 id="注意"><a href="#注意" class="headerlink" title="注意"></a>注意</h4><ol>
<li>shiro 的权限验证机制的逻辑与我们自己预想的可能会有不同。例如：</li>
</ol>
<p>假设用户具有如下权限集合：</p>
<table>
<thead>
<tr>
<th>id</th>
<th>parent_id</th>
<th>res_name</th>
<th>res_type</th>
<th>permission</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td></td>
<td>系统管理</td>
<td>menu</td>
<td>m@sys</td>
</tr>
<tr>
<td>2</td>
<td>1</td>
<td>用户管理</td>
<td>menu</td>
<td>m@sys:usr</td>
</tr>
<tr>
<td>3</td>
<td>1</td>
<td>角色管理</td>
<td>menu</td>
<td>m@sys:role</td>
</tr>
<tr>
<td>4</td>
<td></td>
<td>一级菜单</td>
<td>menu</td>
<td>m@lv1</td>
</tr>
<tr>
<td>5</td>
<td>4</td>
<td>二级菜单1</td>
<td>menu</td>
<td>m@lv1:xxx</td>
</tr>
<tr>
<td>6</td>
<td>4</td>
<td>二级菜单2</td>
<td>menu</td>
<td>m@lv1:yyy</td>
</tr>
<tr>
<td>7</td>
<td>2</td>
<td>用户添加</td>
<td>button</td>
<td>b@usradd</td>
</tr>
</tbody></table>
<p>方法上注解配置的权限为：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequiresPermissions</span>(<span class="string">"m@sys:role:edit"</span>)</span><br></pre></td></tr></table></figure>

<p>当这个用户登录后访问该方法是有权限的  即使 权限中 没有 “m@sys:role:edit”。</p>
<p><strong>shiro 这里的规则是：[root]:[sub_1]:[sub_2]……</strong> （参看Subject.isPermitted()源码）</p>
<p>即以冒号”：“作为分割。左边表示根节点右边表示子节点。如果该用户配置了根节点权限那么其就具备了所有其子节点的权限</p>
<p>上面中用户具有”m@sys“权限。那么”m@sys:usr“ 与 ”m@sys:role“、“m@sys:role:edit”权限就自动具备了。</p>
<p>（个人认为这样设计的目的是为了方便我们在树型目录中给用户来配置权限，只要配置了根节点就具备了其子节点的属性。）</p>
<p>那么反过来就说明权限数据只要这些就行了：</p>
<table>
<thead>
<tr>
<th>id</th>
<th>parent_id</th>
<th>res_name</th>
<th>res_type</th>
<th>permission</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td></td>
<td>系统管理</td>
<td>menu</td>
<td>m@sys</td>
</tr>
<tr>
<td>4</td>
<td></td>
<td>一级菜单</td>
<td>menu</td>
<td>m@lv1</td>
</tr>
<tr>
<td>7</td>
<td>2</td>
<td>用户添加</td>
<td>button</td>
<td>b@usradd</td>
</tr>
</tbody></table>
<ol start="2">
<li>shiro 可能会导致一些事务失效，详情请百度</li>
<li>jwt 生成后如果服务重启 jwt 将失效。因为服务启动每执行 RsaJwkGenerator.generateJwk() 方法，实例不一样。</li>
</ol>
<hr>
<h4 id="参考："><a href="#参考：" class="headerlink" title="参考："></a>参考：</h4><p>jwt 官网：<a href="https://jwt.io/" target="_blank" rel="noopener">https://jwt.io/</a></p>
<p>博客：<a href="https://andaily.com/blog/?p=956" target="_blank" rel="noopener">https://andaily.com/blog/?p=956</a></p>
<p>博客：<a href="https://blog.51cto.com/wyait/2125708" target="_blank" rel="noopener">https://blog.51cto.com/wyait/2125708</a></p>
<p>apache shiro 官网 10 分钟教程：<a href="https://shiro.apache.org/10-minute-tutorial.html" target="_blank" rel="noopener">https://shiro.apache.org/10-minute-tutorial.html</a></p>
<p>apache shiro springboot 教程：<a href="https://shiro.apache.org/spring-boot.html" target="_blank" rel="noopener">https://shiro.apache.org/spring-boot.html</a></p>
<p>博客：<a href="https://segmentfault.com/a/1190000014479154" target="_blank" rel="noopener">https://segmentfault.com/a/1190000014479154</a></p>
<p>博客：<a href="https://segmentfault.com/a/1190000013630601?utm_source=sf-related" target="_blank" rel="noopener">https://segmentfault.com/a/1190000013630601?utm_source=sf-related</a></p>

    </div>

    
    
    
        <div class="reward-container">
  <div></div>
  <button onclick="var qr = document.getElementById('qr'); qr.style.display = (qr.style.display === 'none') ? 'block' : 'none';">
    打赏
  </button>
  <div id="qr" style="display: none;">
      
      <div style="display: inline-block;">
        <img src="https://gitee.com/wu_zhiyong/pic-bed/raw/master/img/微信图片_20200501220918.png" alt="wuzhiyong 微信支付">
        <p>微信支付</p>
      </div>
      
      <div style="display: inline-block;">
        <img src="https://gitee.com/wu_zhiyong/pic-bed/raw/master/img/微信图片_20200501220907.jpg" alt="wuzhiyong 支付宝">
        <p>支付宝</p>
      </div>

  </div>
</div>


      <footer class="post-footer">
          <div class="post-tags">
              <a href="/blog.github.io/tags/springboot/" rel="tag"># springboot</a>
              <a href="/blog.github.io/tags/jwt/" rel="tag"># jwt</a>
              <a href="/blog.github.io/tags/shiro/" rel="tag"># shiro</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/blog.github.io/centOS7-%E5%AE%89%E8%A3%85-redis6-0-6/" rel="prev" title="centOS7 安装 redis6.0.6">
      <i class="fa fa-chevron-left"></i> centOS7 安装 redis6.0.6
    </a></div>
      <div class="post-nav-item">
    <a href="/blog.github.io/%E8%B7%AF%E7%94%B1%E5%99%A8%E8%AE%BE%E7%BD%AE%E5%A4%96%E7%BD%91%E8%AE%BF%E9%97%AE/" rel="next" title="路由器设置外网访问">
      路由器设置外网访问 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          
    <div class="comments" id="valine-comments"></div>

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-4"><a class="nav-link" href="#jwt-介绍"><span class="nav-number">1.</span> <span class="nav-text">jwt 介绍</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#jwt-能做的事"><span class="nav-number">2.</span> <span class="nav-text">jwt 能做的事</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#jwt-组成结构"><span class="nav-number">3.</span> <span class="nav-text">jwt 组成结构</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#java-中使用"><span class="nav-number">4.</span> <span class="nav-text">java 中使用</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#springboot-集成-shiro"><span class="nav-number">5.</span> <span class="nav-text">springboot 集成 shiro</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#传统web方式（前后端不分离）"><span class="nav-number">5.1.</span> <span class="nav-text">传统web方式（前后端不分离）</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#番外篇（简化代码）"><span class="nav-number">5.2.</span> <span class="nav-text">番外篇（简化代码）</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#springboot-集成-shiro-jwt-前后端分离"><span class="nav-number">6.</span> <span class="nav-text">springboot 集成 shiro + jwt (前后端分离)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#异常类"><span class="nav-number">7.</span> <span class="nav-text">异常类</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#注意"><span class="nav-number">8.</span> <span class="nav-text">注意</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#参考："><span class="nav-number">9.</span> <span class="nav-text">参考：</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">wuzhiyong</p>
  <div class="site-description" itemprop="description">吴志勇的博客</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/blog.github.io/archives/">
        
          <span class="site-state-item-count">40</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/blog.github.io/categories/">
          
        <span class="site-state-item-count">10</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/blog.github.io/tags/">
          
        <span class="site-state-item-count">34</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="mailto:wzy563653092@gmail.com" title="E-Mail → mailto:wzy563653092@gmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">wuzhiyong</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
    <span title="站点总字数">260k</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">3:56</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> 强力驱动
  </div>
  <div class="addthis_inline_share_toolbox">
    <script src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5eae29bdce1a511b" async="async"></script>
  </div>

        






<script>
  (function() {
    function leancloudSelector(url) {
      url = encodeURI(url);
      return document.getElementById(url).querySelector('.leancloud-visitors-count');
    }

    function addCount(Counter) {
      var visitors = document.querySelector('.leancloud_visitors');
      var url = decodeURI(visitors.id);
      var title = visitors.dataset.flagTitle;

      Counter('get', '/classes/Counter?where=' + encodeURIComponent(JSON.stringify({ url })))
        .then(response => response.json())
        .then(({ results }) => {
          if (results.length > 0) {
            var counter = results[0];
            leancloudSelector(url).innerText = counter.time + 1;
            Counter('put', '/classes/Counter/' + counter.objectId, { time: { '__op': 'Increment', 'amount': 1 } })
              .catch(error => {
                console.error('Failed to save visitor count', error);
              });
          } else {
              Counter('post', '/classes/Counter', { title, url, time: 1 })
                .then(response => response.json())
                .then(() => {
                  leancloudSelector(url).innerText = 1;
                })
                .catch(error => {
                  console.error('Failed to create', error);
                });
          }
        })
        .catch(error => {
          console.error('LeanCloud Counter Error', error);
        });
    }

    function showTime(Counter) {
      var visitors = document.querySelectorAll('.leancloud_visitors');
      var entries = [...visitors].map(element => {
        return decodeURI(element.id);
      });

      Counter('get', '/classes/Counter?where=' + encodeURIComponent(JSON.stringify({ url: { '$in': entries } })))
        .then(response => response.json())
        .then(({ results }) => {
          for (let url of entries) {
            let target = results.find(item => item.url === url);
            leancloudSelector(url).innerText = target ? target.time : 0;
          }
        })
        .catch(error => {
          console.error('LeanCloud Counter Error', error);
        });
    }

    let { app_id, app_key, server_url } = {"enable":true,"app_id":"jOjNqcMeMLL4ntoMdf13veTb-MdYXbMMI","app_key":"v50rUeYs7yeT6hECN7XAhYYM","server_url":null,"security":false};
    function fetchData(api_server) {
      var Counter = (method, url, data) => {
        return fetch(`${api_server}/1.1${url}`, {
          method,
          headers: {
            'X-LC-Id'     : app_id,
            'X-LC-Key'    : app_key,
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(data)
        });
      };
      if (CONFIG.page.isPost) {
        // if (CONFIG.hostname !== location.hostname) return;
        addCount(Counter);
      } else if (document.querySelectorAll('.post-title-link').length >= 1) {
        showTime(Counter);
      }
    }

    let api_server = app_id.slice(-9) !== '-MdYXbMMI' ? server_url : `https://${app_id.slice(0, 8).toLowerCase()}.api.lncldglobal.com`;

    if (api_server) {
      fetchData(api_server);
    } else {
      fetch('https://app-router.leancloud.cn/2/route?appId=' + app_id)
        .then(response => response.json())
        .then(({ api_server }) => {
          fetchData('https://' + api_server);
        });
    }
  })();
</script>


      </div>
    </footer>
  </div>

  
  <script src="/blog.github.io/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script>
  <script src="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/lozad@1/dist/lozad.min.js"></script>
  <script src="/blog.github.io/lib/velocity/velocity.min.js"></script>
  <script src="/blog.github.io/lib/velocity/velocity.ui.min.js"></script>

<script src="/blog.github.io/js/utils.js"></script>

<script src="/blog.github.io/js/motion.js"></script>


<script src="/blog.github.io/js/schemes/muse.js"></script>


<script src="/blog.github.io/js/next-boot.js"></script>




  




  
<script src="/blog.github.io/js/local-search.js"></script>













  

  


<script>
NexT.utils.loadComments(document.querySelector('#valine-comments'), () => {
  NexT.utils.getScript('//unpkg.com/valine/dist/Valine.min.js', () => {
    var GUEST = ['nick', 'mail', 'link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item => {
      return GUEST.includes(item);
    });
    new Valine({
      el         : '#valine-comments',
      verify     : false,
      notify     : false,
      appId      : 'jOjNqcMeMLL4ntoMdf13veTb-MdYXbMMI',
      appKey     : 'v50rUeYs7yeT6hECN7XAhYYM',
      placeholder: "Just go go",
      avatar     : 'mm',
      meta       : guest,
      pageSize   : '10' || 10,
      visitor    : false,
      lang       : 'zh-cn' || 'zh-cn',
      path       : location.pathname,
      recordIP   : false,
      serverURLs : ''
    });
  }, window.Valine);
});
</script>

</body>
</html>
