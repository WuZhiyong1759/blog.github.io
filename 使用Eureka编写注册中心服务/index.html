<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.1">
  <link rel="apple-touch-icon" sizes="180x180" href="/myblog/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/myblog/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/myblog/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/myblog/images/logo.svg" color="#222">

<link rel="stylesheet" href="/myblog/css/main.css">


<link rel="stylesheet" href="/myblog/lib/font-awesome/css/all.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"wu_zhiyong.gitee.io","root":"/myblog/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":true,"mediumzoom":false,"lazyload":true,"pangu":false,"comments":{"style":"tabs","active":null,"storage":false,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="引言 Spring Cloud Eureka是 Spring Cloud Netflix微服务套件的一部分，基于 Netflix Eurd做了二次封装，主要负责实现微服务架构中的服务治理功能。 Spring Cloud Eureka是一个基于REST的服务，并且提供了基于Java的客户端组件，能够非常方便地将服务注到Spring Cloud Eureka中进行统一管理。 注册中心带来的好处就是，不">
<meta property="og:type" content="article">
<meta property="og:title" content="使用Eureka编写注册中心服务">
<meta property="og:url" content="http://wu_zhiyong.gitee.io/myblog/%E4%BD%BF%E7%94%A8Eureka%E7%BC%96%E5%86%99%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83%E6%9C%8D%E5%8A%A1/index.html">
<meta property="og:site_name" content="吴志勇的博客">
<meta property="og:description" content="引言 Spring Cloud Eureka是 Spring Cloud Netflix微服务套件的一部分，基于 Netflix Eurd做了二次封装，主要负责实现微服务架构中的服务治理功能。 Spring Cloud Eureka是一个基于REST的服务，并且提供了基于Java的客户端组件，能够非常方便地将服务注到Spring Cloud Eureka中进行统一管理。 注册中心带来的好处就是，不">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://wu_zhiyong.gitee.io/myblog/%E4%BD%BF%E7%94%A8Eureka%E7%BC%96%E5%86%99%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83%E6%9C%8D%E5%8A%A1/image-20200428193338935.png">
<meta property="og:image" content="http://wu_zhiyong.gitee.io/myblog/%E4%BD%BF%E7%94%A8Eureka%E7%BC%96%E5%86%99%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83%E6%9C%8D%E5%8A%A1/image-20200428201536367.png">
<meta property="og:image" content="http://wu_zhiyong.gitee.io/myblog/%E4%BD%BF%E7%94%A8Eureka%E7%BC%96%E5%86%99%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83%E6%9C%8D%E5%8A%A1/image-20200428203217712.png">
<meta property="og:image" content="http://wu_zhiyong.gitee.io/myblog/%E4%BD%BF%E7%94%A8Eureka%E7%BC%96%E5%86%99%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83%E6%9C%8D%E5%8A%A1/image-20200428211048055.png">
<meta property="og:image" content="http://wu_zhiyong.gitee.io/myblog/%E4%BD%BF%E7%94%A8Eureka%E7%BC%96%E5%86%99%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83%E6%9C%8D%E5%8A%A1/image-20200428204803431.png">
<meta property="og:image" content="http://wu_zhiyong.gitee.io/myblog/%E4%BD%BF%E7%94%A8Eureka%E7%BC%96%E5%86%99%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83%E6%9C%8D%E5%8A%A1/image-20200428213312803.png">
<meta property="og:image" content="http://wu_zhiyong.gitee.io/myblog/%E4%BD%BF%E7%94%A8Eureka%E7%BC%96%E5%86%99%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83%E6%9C%8D%E5%8A%A1/image-20200428215931142.png">
<meta property="og:image" content="http://wu_zhiyong.gitee.io/myblog/%E4%BD%BF%E7%94%A8Eureka%E7%BC%96%E5%86%99%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83%E6%9C%8D%E5%8A%A1/image-20200429132054476.png">
<meta property="og:image" content="http://wu_zhiyong.gitee.io/myblog/%E4%BD%BF%E7%94%A8Eureka%E7%BC%96%E5%86%99%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83%E6%9C%8D%E5%8A%A1/image-20200429133958776.png">
<meta property="og:image" content="http://wu_zhiyong.gitee.io/myblog/%E4%BD%BF%E7%94%A8Eureka%E7%BC%96%E5%86%99%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83%E6%9C%8D%E5%8A%A1/image-20200429134015432.png">
<meta property="og:image" content="http://wu_zhiyong.gitee.io/myblog/%E4%BD%BF%E7%94%A8Eureka%E7%BC%96%E5%86%99%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83%E6%9C%8D%E5%8A%A1/image-20200429135803033.png">
<meta property="og:image" content="http://wu_zhiyong.gitee.io/myblog/%E4%BD%BF%E7%94%A8Eureka%E7%BC%96%E5%86%99%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83%E6%9C%8D%E5%8A%A1/image-20200429135941147.png">
<meta property="og:image" content="http://wu_zhiyong.gitee.io/myblog/%E4%BD%BF%E7%94%A8Eureka%E7%BC%96%E5%86%99%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83%E6%9C%8D%E5%8A%A1/image-20200429140121377.png">
<meta property="og:image" content="http://wu_zhiyong.gitee.io/myblog/%E4%BD%BF%E7%94%A8Eureka%E7%BC%96%E5%86%99%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83%E6%9C%8D%E5%8A%A1/image-20200429141503793.png">
<meta property="og:image" content="http://wu_zhiyong.gitee.io/myblog/%E4%BD%BF%E7%94%A8Eureka%E7%BC%96%E5%86%99%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83%E6%9C%8D%E5%8A%A1/image-20200429142503537.png">
<meta property="og:image" content="http://wu_zhiyong.gitee.io/myblog/%E4%BD%BF%E7%94%A8Eureka%E7%BC%96%E5%86%99%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83%E6%9C%8D%E5%8A%A1/image-20200429144244592.png">
<meta property="og:image" content="http://wu_zhiyong.gitee.io/myblog/%E4%BD%BF%E7%94%A8Eureka%E7%BC%96%E5%86%99%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83%E6%9C%8D%E5%8A%A1/image-20200429152545740.png">
<meta property="article:published_time" content="2020-04-28T06:31:27.000Z">
<meta property="article:modified_time" content="2020-05-01T15:34:19.838Z">
<meta property="article:author" content="wuzhiyong">
<meta property="article:tag" content="springboot">
<meta property="article:tag" content="java">
<meta property="article:tag" content="spring cloud">
<meta property="article:tag" content="Eureka">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://wu_zhiyong.gitee.io/myblog/%E4%BD%BF%E7%94%A8Eureka%E7%BC%96%E5%86%99%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83%E6%9C%8D%E5%8A%A1/image-20200428193338935.png">

<link rel="canonical" href="http://wu_zhiyong.gitee.io/myblog/%E4%BD%BF%E7%94%A8Eureka%E7%BC%96%E5%86%99%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83%E6%9C%8D%E5%8A%A1/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>使用Eureka编写注册中心服务 | 吴志勇的博客</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/myblog/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">吴志勇的博客</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">学习、记录、总结、侃大山</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/myblog/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/myblog/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/myblog/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/myblog/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://wu_zhiyong.gitee.io/myblog/%E4%BD%BF%E7%94%A8Eureka%E7%BC%96%E5%86%99%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83%E6%9C%8D%E5%8A%A1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/myblog/images/avatar.gif">
      <meta itemprop="name" content="wuzhiyong">
      <meta itemprop="description" content="吴志勇的博客">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="吴志勇的博客">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          使用Eureka编写注册中心服务
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-04-28 14:31:27" itemprop="dateCreated datePublished" datetime="2020-04-28T14:31:27+08:00">2020-04-28</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-05-01 23:34:19" itemprop="dateModified" datetime="2020-05-01T23:34:19+08:00">2020-05-01</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/myblog/categories/%E7%BC%96%E7%A8%8B/" itemprop="url" rel="index"><span itemprop="name">编程</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/myblog/categories/%E7%BC%96%E7%A8%8B/%E5%90%8E%E7%AB%AF/" itemprop="url" rel="index"><span itemprop="name">后端</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/myblog/categories/%E7%BC%96%E7%A8%8B/%E5%90%8E%E7%AB%AF/java/" itemprop="url" rel="index"><span itemprop="name">java</span></a>
                </span>
            </span>

          
            <span id="/myblog/%E4%BD%BF%E7%94%A8Eureka%E7%BC%96%E5%86%99%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83%E6%9C%8D%E5%8A%A1/" class="post-meta-item leancloud_visitors" data-flag-title="使用Eureka编写注册中心服务" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/myblog/%E4%BD%BF%E7%94%A8Eureka%E7%BC%96%E5%86%99%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83%E6%9C%8D%E5%8A%A1/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/myblog/%E4%BD%BF%E7%94%A8Eureka%E7%BC%96%E5%86%99%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83%E6%9C%8D%E5%8A%A1/" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>15k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>13 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h3 id="引言"><a href="#引言" class="headerlink" title="引言"></a>引言</h3><blockquote>
<p>Spring Cloud Eureka是 Spring Cloud Netflix微服务套件的一部分，基于 Netflix Eurd做了二次封装，主要负责实现微服务架构中的服务治理功能。 Spring Cloud Eureka是一个基于REST的服务，并且提供了基于Java的客户端组件，能够非常方便地将服务注到Spring Cloud Eureka中进行统一管理。</p>
<p>注册中心带来的好处就是，不需要知道有多少提供方，你只需要关注注册中心即可，就像顺客不必关心有多少火车在开行，只需要去12306网站上看有没有票就可以了。为什么 Eureka比 Zookeeper更适合作为注册中心呢？主要是因为 Eureka是基于AP原则构建的，而 Zookeeper是基于CP原则构建的。在分布式系统领域有个著名的CAP定理，即C为数据一致性；A为服务可用性；P为服务对网络分区故障的容错性。这三个特性在任何分布式系统中都不能同时满足，最多同时满足两个。</p>
<p>Zookeeper有一个 Leader，而且在这个 Leader无法使用的时候通过 Paxos（ZAB）算法选举出一个新的 Leader.。这个 Leader的任务就是保证写数据的时候只向这个 Leader写入，Leader会同步信息到其他节点。通过这个操作就可以保证数据的一致性。</p>
<p>总而言之，想要保证AP就要用 Eureka，想要保证CP就要用 Zookeeper。Dubo中大部分都是基于 Zookeeper作为注册中心的。 Spring Cloud中当然首选 Eureka</p>
<p align="right">——《spring cloud 微服务 入门、进阶与实战》第33页<p>
</blockquote>
<h3 id="开始"><a href="#开始" class="headerlink" title="开始"></a>开始</h3><p>创建一个spring cloud 项目springcloud-eureka-server。（这里创建一个spring boot 再引入 spring cloud 的依赖也是一样）<a id="more"></a></p>
<ol>
<li>这个是注册中心需要的依赖</li>
</ol>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-server<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li><p>这里也贴出spring boot 与 spring cloud 的依赖（之所以贴出来是因为我没有参照书中的添加，然后服务出错了启动不了，经过折腾发现 spring boot 与 spring cloud 的版本是有对应关系的）</p>
<p>参照官网：</p>
<p><a href="https://spring.io/projects/spring-cloud" target="_blank" rel="noopener">https://spring.io/projects/spring-cloud</a></p>
<img data-src="/myblog/%E4%BD%BF%E7%94%A8Eureka%E7%BC%96%E5%86%99%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83%E6%9C%8D%E5%8A%A1/image-20200428193338935.png" class="">

</li>
</ol>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.2.6.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">relativePath</span>/&gt;</span> <span class="comment">&lt;!-- lookup parent from repository --&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">spring-cloud.version</span>&gt;</span>Hoxton.SR4<span class="tag">&lt;/<span class="name">spring-cloud.version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;spring-cloud.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencyManagement</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>application.properties加入配置：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">spring.application.name</span>=<span class="string">eureka-server</span></span><br><span class="line"><span class="meta">server.port</span>=<span class="string">8761</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#由于该应用为注册中心，所以设置为false，代表不向注册中心注册自己</span></span><br><span class="line"><span class="meta">eureka.client.register-with-eureka</span>=<span class="string">false</span></span><br><span class="line"><span class="comment">#由于注册中心的职责就是维护服务实例，它并不需要去检索服务，所以也设置成false</span></span><br><span class="line"><span class="meta">eureka.client.fetch-registry</span>=<span class="string">false</span></span><br></pre></td></tr></table></figure>

<p>启动类加上@EnableEurekaServer注解</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableEurekaServer</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SpringcloudEurekaServerApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(SpringcloudEurekaServerApplication<span class="class">.<span class="keyword">class</span>, <span class="title">args</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>启动访问<a href="http://localhost:8761/" target="_blank" rel="noopener">http://localhost:8761/</a> 可看到页面：</p>
<img data-src="/myblog/%E4%BD%BF%E7%94%A8Eureka%E7%BC%96%E5%86%99%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83%E6%9C%8D%E5%8A%A1/image-20200428201536367.png" class="">

<p>这里只是一个空的注册中心，里边还没有服务。接下来我们来创建两个服务注册到服务中心去：</p>
<h3 id="服务提供者"><a href="#服务提供者" class="headerlink" title="服务提供者"></a>服务提供者</h3><p>和上边一样创建一个spring cloud 项目 springcloud-eureka-server-Provider（引入上边spring boot 和spring cloud的依赖）再加上eureka 客户端的依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 与注册中心  不同的是 这里是 eureka-client --&gt;</span></span><br></pre></td></tr></table></figure>

<p>在启动类上加入@EnableEurekaClient 注解</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableEurekaClient</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SpringcloudEurekaServerProviderApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(SpringcloudEurekaServerProviderApplication<span class="class">.<span class="keyword">class</span>, <span class="title">args</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们在来编写一个测试的接口：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/user/hello"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">hello</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"hello"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>application.properties</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">spring.application.name</span>=<span class="string">eureka-client-user-service</span></span><br><span class="line"><span class="meta">server.port</span>=<span class="string">8081</span></span><br><span class="line"><span class="meta">eureka.client.serviceUrl.defaultZone</span>=<span class="string">http://localhost:8761/eureka/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#采用IP注册</span></span><br><span class="line"><span class="meta">eureka.instance.preferIpAddress</span>=<span class="string">true</span></span><br><span class="line"><span class="comment">#定义实例ID格式</span></span><br><span class="line"><span class="meta">eureka.instance.instance-id</span>=<span class="string">$&#123;spring.application.name&#125;:$&#123;spring.cloud.client.ip.address&#125;:$&#123;server.port&#125;</span></span><br></pre></td></tr></table></figure>

<p>启动后在再刷新注册中心的页面可看到有了一个服务实例：</p>
<img data-src="/myblog/%E4%BD%BF%E7%94%A8Eureka%E7%BC%96%E5%86%99%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83%E6%9C%8D%E5%8A%A1/image-20200428203217712.png" class="">

<h3 id="服务消费者"><a href="#服务消费者" class="headerlink" title="服务消费者"></a>服务消费者</h3><p>首先与服务提供者一样建立一个spring cloud 项目 springcloud-eureka-server-Consumer，pom 依赖也一样</p>
<p>application.properties 基本一样，我们修改下服务名称和端口：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">spring.application.name</span>=<span class="string">eureka-client-article-service</span></span><br><span class="line"><span class="meta">server.port</span>=<span class="string">8082</span></span><br><span class="line"><span class="meta">eureka.client.serviceUrl.defaultZone</span>=<span class="string">http://localhost:8761/eureka/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#采用IP注册</span></span><br><span class="line"><span class="meta">eureka.instance.prefer-ip-address</span>=<span class="string">true</span></span><br><span class="line"><span class="comment">#定义实例ID格式</span></span><br><span class="line"><span class="meta">eureka.instance.instance-id</span>=<span class="string">$&#123;spring.application.name&#125;:$&#123;spring.cloud.client.ip.address&#125;:$&#123;server.port&#125;</span></span><br></pre></td></tr></table></figure>

<p>再建立两个类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BeanConfiguration</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RestTemplate <span class="title">getRestTemplate</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> RestTemplate();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ArticleController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RestTemplate restTemplate;</span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/article/callHello"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">callHello</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> restTemplate.getForObject(<span class="string">"http://localhost:8081/user/hello"</span>,String<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>启动后可看到配置中心有了两个实例</p>
<img data-src="/myblog/%E4%BD%BF%E7%94%A8Eureka%E7%BC%96%E5%86%99%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83%E6%9C%8D%E5%8A%A1/image-20200428211048055.png" class="">

<p>我们来访问下消费者的接口得到返回：</p>
<img data-src="/myblog/%E4%BD%BF%E7%94%A8Eureka%E7%BC%96%E5%86%99%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83%E6%9C%8D%E5%8A%A1/image-20200428204803431.png" class="">

<p>从代码我们可以看到。我们访问 <a href="http://localhost:8082/article/callHello" target="_blank" rel="noopener">http://localhost:8082/article/callHello</a> 接口，其实在控制器里是通过restTemplate访问 服务提供者<a href="http://localhost:8081/user/hello接口返回数据的" target="_blank" rel="noopener">http://localhost:8081/user/hello接口返回数据的</a></p>
<p>restTemplate通过localhost:8081其实并没有通过配置中心来消费接口。</p>
<p>我们可以通过以下配置：</p>
<p>在BeanConfiguration中加入@LoadBalanced注解</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BeanConfiguration</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@LoadBalanced</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RestTemplate <span class="title">getRestTemplate</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> RestTemplate();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>restTemplate就可以通过实例的名称 eureka-client-user-service 来访问了</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping</span>(<span class="string">"/article/callHello"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">callHello</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> restTemplate.getForObject(<span class="string">"http://eureka-client-user-service/user/hello"</span>,String<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>这样才是利用了配置中心来消费接口</p>
<h3 id="开启Eureka认证"><a href="#开启Eureka认证" class="headerlink" title="开启Eureka认证"></a>开启Eureka认证</h3><blockquote>
<p>Eureka自带了一个Web的管理页面，方便我们查询注册到上面的实例信息，但是有一个题：如果在实际使用中，注册中心地址有公网1P的话，必然能直接访问到，这样是不安全的。所以我们需要对 Eureka进行改造，加上权限认证来保证安全性改造我们的eureka- server，通过集成 Spring-security来进行安全认证在 pom. xml中添加Spring- Security的依赖包</p>
<p align="right">——《spring cloud 微服务 入门、进阶与实战》第39页<p>
</blockquote>
<p>在注册中心 springcloud-eureka-server 加入security依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-security<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>增加配置class文件：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableWebSecurity</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebSecurityConfig</span> <span class="keyword">extends</span> <span class="title">WebSecurityConfigurerAdapter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        http.csrf().disable()</span><br><span class="line">                .authorizeRequests()</span><br><span class="line">                .anyRequest().authenticated()</span><br><span class="line">                .and()</span><br><span class="line">                .httpBasic();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>properties增加配置用户名和密码</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">spring.security.user.name</span>=<span class="string">WuZhiYong</span></span><br><span class="line"><span class="meta">spring.security.user.password</span>=<span class="string">123456</span></span><br></pre></td></tr></table></figure>

<p>重新启动注册中心，访问htp：/ localhost：8761，此时浏览器会提示你输入用户名和密，人正确后才能继续访问 Eureka提供的管理页面。</p>
<p>在 Eureka开启认证后，客户端注册的配置也要加上认证的用户名和密码信息：</p>
<p>否则无法启动成功（不能注册到注册中心）</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">eureka.client.serviceUrl.defaultZone</span>=<span class="string">http://WuZhiYong:123456@localhost:8761/eureka/</span></span><br></pre></td></tr></table></figure>

<h3 id="关闭自我保护"><a href="#关闭自我保护" class="headerlink" title="关闭自我保护"></a>关闭自我保护</h3><blockquote>
<p>保护模式主要在一组客户端和 Eureka Server之间存在网络分区场景时使用。一且进入保护模式， Eureka Server将会尝试保护其服务的注册表中的信息，不再删除服务注册表中的数据。当网络故障恢复后，该 Eureka Server节点会自动退出保护模式。</p>
<p align="right">——《spring cloud 微服务 入门、进阶与实战》第41页<p>
</blockquote>
<p>访问注册中心页面的时候有时会出现这样的提示：即表示进入保护模式了</p>
<img data-src="/myblog/%E4%BD%BF%E7%94%A8Eureka%E7%BC%96%E5%86%99%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83%E6%9C%8D%E5%8A%A1/image-20200428213312803.png" class="">

<p>在配置文件中我们可这样关闭保护模式</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">eureka.server.enable-self-preservation</span>=<span class="string">false</span></span><br></pre></td></tr></table></figure>

<p>在刷新页面会显示：</p>
<blockquote>
<p>THE SELF PRESERVATION MODE IS TURNED OFF. THIS MAY NOT PROTECT INSTANCE EXPIRY IN CASE OF NETWORK/OTHER PROBLEMS.</p>
</blockquote>
<blockquote>
<p>(翻译：自我保存模式已关闭。在网络/其他问题的情况下，这可能无法保护实例到期)</p>
</blockquote>
<h3 id="自定义Eureka的实例（instanceId）ID"><a href="#自定义Eureka的实例（instanceId）ID" class="headerlink" title="自定义Eureka的实例（instanceId）ID"></a>自定义Eureka的实例（instanceId）ID</h3><p>自定义实例id在配置文件中已做了注释说明。</p>
<p>不过我们前面在注册中心页面上看到的实例id的时候并没有象我们配置的那样呈现出了ip地址。实际上这是由于不同版本造成的。这里改成下面这样就好了。</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#定义实例ID格式</span></span><br><span class="line"><span class="meta">eureka.instance.instance-id</span>=<span class="string">$&#123;spring.application.name&#125;:$&#123;spring.cloud.client.ip-address&#125;:$&#123;server.port&#125;</span></span><br></pre></td></tr></table></figure>

<p>再看发现正常显示ip了</p>
<img data-src="/myblog/%E4%BD%BF%E7%94%A8Eureka%E7%BC%96%E5%86%99%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83%E6%9C%8D%E5%8A%A1/image-20200428215931142.png" class="">

<h3 id="自定义实例跳转链接"><a href="#自定义实例跳转链接" class="headerlink" title="自定义实例跳转链接"></a>自定义实例跳转链接</h3><blockquote>
<p>我们通过配置实现了用IP进行注册，当点击 Instance ID进行跳转的时就可以用P跳转了，跳转的地址默认是IP+ Port/info。我们可以自定义这个跳转的地址</p>
</blockquote>
<p>比如配置跳转到我的博客（在非注册中心的项目里配置）</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#配置跳转链接</span></span><br><span class="line"><span class="meta">eureka.instance.status-page-url</span>=<span class="string">https://wu_zhiyong.gitee.io/myblog/</span></span><br></pre></td></tr></table></figure>

<p>点击实例ID后就会跳转到我的博客</p>
<h3 id="快速移除已失效的服务信息"><a href="#快速移除已失效的服务信息" class="headerlink" title="快速移除已失效的服务信息"></a>快速移除已失效的服务信息</h3><blockquote>
<p>在实际开发过程中，我们可能会不停地重启服务，由于 Eureka有自己的保护机制，故节点下线后，服务信息还会一直存在于 Eureka中。我们可以通过增加一些配置让移除的速度更快一点，当然只在开发环境下使用，生产环境下不推荐使用。</p>
<p align="right">——《spring cloud 微服务 入门、进阶与实战》第43页<p>
</blockquote>
<p>首先在 eureka-server 注册中心添加配置：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#别是关闭自我保护</span></span><br><span class="line"><span class="meta">eureka.server.enable-self-preservation</span>=<span class="string">false</span></span><br><span class="line"><span class="comment">#清理间隔 默认60000</span></span><br><span class="line"><span class="meta">eureka.server.eviction-interval-timer-in-ms</span>=<span class="string">5000</span></span><br></pre></td></tr></table></figure>

<p>然后在具体的服务中配置：（本例中就是前面说的服务提供者和消费者两个服务）</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#开启健康检查</span></span><br><span class="line"><span class="meta">eureka.client.healthcheck.enabled</span>=<span class="string">true</span></span><br><span class="line"><span class="comment"># 表示注册的服务向eureka配置中心发送心跳的频率  默认30秒</span></span><br><span class="line"><span class="meta">eureka.instance.lease-renewal-interval-in-seconds</span>=<span class="string">5</span></span><br><span class="line"><span class="comment"># 表示eureka配置中心向注册的服务们自上一次心跳后等待下一次心跳的超时时间，</span></span><br><span class="line"><span class="comment"># 在这个过程中没有收到则移除实例  默认90秒</span></span><br><span class="line"><span class="meta">eureka.instance.lease-expiration-duration-in-seconds</span>=<span class="string">5</span></span><br></pre></td></tr></table></figure>

<p>同时加上健康检查的依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>更多的配置信息可参考EurekaInstanceConfigBean 和 EurekaServerConfigBean</p>
<h3 id="Eureka高可用搭建"><a href="#Eureka高可用搭建" class="headerlink" title="Eureka高可用搭建"></a>Eureka高可用搭建</h3><h4 id="高可用原理"><a href="#高可用原理" class="headerlink" title="高可用原理"></a>高可用原理</h4><blockquote>
<p>前面我们搭建的注册中心只适合本地开发使用，在生产环境中必须搭建一个集群来保证高可用。 Eureka的集群搭建方法很简单：每一台 Eureka只需要在配置中指定另外多个Eureka的地址就可以实现一个集群的搭建了。</p>
<p align="right">——《spring cloud 微服务 入门、进阶与实战》第39页<p>
</blockquote>
<h4 id="搭建步骤"><a href="#搭建步骤" class="headerlink" title="搭建步骤"></a>搭建步骤</h4><p>简单说明：</p>
<p>如果有主、从两个注册中心</p>
<p>将    主    注册-&gt;到    从</p>
<p>将    从    注册-&gt;到    主</p>
<p>如果有主、从1、从2三个注册中心（以此类推）</p>
<p>将    主    注册-&gt;到    从1、从2</p>
<p>将    从1    注册-&gt;到    主、从2</p>
<p>将    从2    注册-&gt;到    主、从1    </p>
<p>以搭建主、从注册中心为例：</p>
<p>参照eureka-server建立一个项目（或复制一个项目）项目名我们就叫做 springcloud-eureka-server-cluster.</p>
<p>至此我们现在有四个项目了</p>
<img data-src="/myblog/%E4%BD%BF%E7%94%A8Eureka%E7%BC%96%E5%86%99%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83%E6%9C%8D%E5%8A%A1/image-20200429132054476.png" class="">

<p>简单说明下：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#注册中心服务</span></span><br><span class="line"><span class="attr">springcloud-eureka-server</span></span><br><span class="line"><span class="comment">#注册中心服务的复制版（用于高可用）</span></span><br><span class="line"><span class="attr">springcloud-eureka-server-cluster</span></span><br><span class="line"><span class="comment">#服务消费者 注册到注册中心</span></span><br><span class="line"><span class="attr">springcloud-eureka-server-consumer</span></span><br><span class="line"><span class="comment">#服务提供者 注册到注册中心</span></span><br><span class="line"><span class="attr">springcloud-eureka-server-provider</span></span><br></pre></td></tr></table></figure>

<p>我们先看eureka-server的application.properties</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">server.port</span>=<span class="string">8761</span></span><br><span class="line"><span class="meta">spring.application.name</span>=<span class="string">eureka-server</span></span><br><span class="line"><span class="comment">#指向从节点的注册中心</span></span><br><span class="line"><span class="meta">eureka.client.serviceUrl.defaultZone</span>=<span class="string">http://WuZhiYong:123456@localhost:8762/eureka/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#由于该应用为注册中心，所以设置为false，代表不向注册中心注册自己</span></span><br><span class="line"><span class="meta">eureka.client.register-with-eureka</span>=<span class="string">false</span></span><br><span class="line"><span class="comment">#由于注册中心的职责就是维护服务实例，它并不需要去检索服务，所以也设置成false</span></span><br><span class="line"><span class="meta">eureka.client.fetch-registry</span>=<span class="string">false</span></span><br><span class="line"></span><br><span class="line"><span class="meta">spring.security.user.name</span>=<span class="string">WuZhiYong</span></span><br><span class="line"><span class="meta">spring.security.user.password</span>=<span class="string">123456</span></span><br><span class="line"><span class="comment">#别是关闭自我保护</span></span><br><span class="line"><span class="meta">eureka.server.enable-self-preservation</span>=<span class="string">false</span></span><br><span class="line"><span class="comment">#清理间隔 默认60000</span></span><br><span class="line"><span class="meta">eureka.server.eviction-interval-timer-in-ms</span>=<span class="string">5000</span></span><br></pre></td></tr></table></figure>

<p>再看看eureka-server-cluster的application.properties</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">server.port</span>=<span class="string">8762</span></span><br><span class="line"><span class="meta">spring.application.name</span>=<span class="string">eureka-server-cluster</span></span><br><span class="line"><span class="comment">#指向主节点的注册中心</span></span><br><span class="line"><span class="meta">eureka.client.serviceUrl.defaultZone</span>=<span class="string">http://WuZhiYong:123456@localhost:8761/eureka/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#由于该应用为注册中心，所以设置为false，代表不向注册中心注册自己</span></span><br><span class="line"><span class="meta">eureka.client.register-with-eureka</span>=<span class="string">false</span></span><br><span class="line"><span class="comment">#由于注册中心的职责就是维护服务实例，它并不需要去检索服务，所以也设置成false</span></span><br><span class="line"><span class="meta">eureka.client.fetch-registry</span>=<span class="string">false</span></span><br><span class="line"></span><br><span class="line"><span class="meta">spring.security.user.name</span>=<span class="string">WuZhiYong</span></span><br><span class="line"><span class="meta">spring.security.user.password</span>=<span class="string">123456</span></span><br><span class="line"><span class="comment">#别是关闭自我保护</span></span><br><span class="line"><span class="meta">eureka.server.enable-self-preservation</span>=<span class="string">false</span></span><br><span class="line"><span class="comment">#清理间隔 默认60000</span></span><br><span class="line"><span class="meta">eureka.server.eviction-interval-timer-in-ms</span>=<span class="string">5000</span></span><br></pre></td></tr></table></figure>

<p>配置也基本相同。只是端口和注册中心的地址不一样。</p>
<p>好的。我们再把server-provider和server-consumer的application.properties里的注册中心指向上面的两个：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">eureka.client.serviceUrl.defaultZone</span>=<span class="string">http://WuZhiYong:123456@localhost:8761/eureka/,http://WuZhiYong:123456@localhost:8762/eureka/</span></span><br></pre></td></tr></table></figure>

<p>好了，高可用的配置已经完成，我们分别启动主从注册中心，然后再启动 server-provider和server-consumer。</p>
<p>分别访问<a href="http://localhost:8762/与http://localhost:8761/都能看到里边俩个服务。" target="_blank" rel="noopener">http://localhost:8762/与http://localhost:8761/都能看到里边俩个服务。</a></p>
<img data-src="/myblog/%E4%BD%BF%E7%94%A8Eureka%E7%BC%96%E5%86%99%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83%E6%9C%8D%E5%8A%A1/image-20200429133958776.png" class="">



<img data-src="/myblog/%E4%BD%BF%E7%94%A8Eureka%E7%BC%96%E5%86%99%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83%E6%9C%8D%E5%8A%A1/image-20200429134015432.png" class="">

<p>然后我们后台任意停止一个注册中心。我们访问server-consumer的接口时，依然能正确调用到server-provider的服务并返回数据。</p>
<h3 id="扩展使用"><a href="#扩展使用" class="headerlink" title="扩展使用"></a>扩展使用</h3><h4 id="Eureka-REST-API"><a href="#Eureka-REST-API" class="headerlink" title="Eureka REST API"></a>Eureka REST API</h4><p>Eureka 提供了一些API用于获取某个服务的注册信息</p>
<p>官方文档：</p>
<p><a href="https://github.com/Netflix/eureka/wiki/Eureka-REST-operations" target="_blank" rel="noopener">https://github.com/Netflix/eureka/wiki/Eureka-REST-operations</a></p>
<p>以上面我们启动的服务为例调用api</p>
<p><a href="http://localhost:8761/eureka/apps/eureka-client-user-service" target="_blank" rel="noopener">http://localhost:8761/eureka/apps/eureka-client-user-service</a></p>
<p>localhost:8761 是注册中心的地址</p>
<p>eureka-client-user-service  是服务实例的名称</p>
<p>如果配置中心没有加入security认证机制直接访问上面的地址就可以得到xml格式的数据响应。</p>
<p>如果 Eureka开启了认证，记得添加认证信息，用户名和密码必须是Base64编码过的Authorization： Basic用户名：密码，其余的接口就不做过多讲解了，大家可以自己去尝试。Postman直接支持了 Basic认证，将选项从 Headers切换到 Authorization，选择认证方式为Basic Auth就可以填写用户信息了</p>
<img data-src="/myblog/%E4%BD%BF%E7%94%A8Eureka%E7%BC%96%E5%86%99%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83%E6%9C%8D%E5%8A%A1/image-20200429135803033.png" class="">

<p>如果想返回json需在headers 中添加：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">Content-Type</span>:<span class="string">application/json</span></span><br><span class="line"><span class="attr">Accept</span>:<span class="string">application/json</span></span><br></pre></td></tr></table></figure>

<img data-src="/myblog/%E4%BD%BF%E7%94%A8Eureka%E7%BC%96%E5%86%99%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83%E6%9C%8D%E5%8A%A1/image-20200429135941147.png" class="">

<p>配置好后点击发送</p>
<img data-src="/myblog/%E4%BD%BF%E7%94%A8Eureka%E7%BC%96%E5%86%99%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83%E6%9C%8D%E5%8A%A1/image-20200429140121377.png" class="">

<p>响应的json</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"application"</span>: &#123;</span><br><span class="line">        <span class="attr">"name"</span>: <span class="string">"EUREKA-CLIENT-USER-SERVICE"</span>,</span><br><span class="line">        <span class="attr">"instance"</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="attr">"instanceId"</span>: <span class="string">"eureka-client-user-service:192.168.0.106:8081"</span>,</span><br><span class="line">                <span class="attr">"hostName"</span>: <span class="string">"192.168.0.106"</span>,</span><br><span class="line">                <span class="attr">"app"</span>: <span class="string">"EUREKA-CLIENT-USER-SERVICE"</span>,</span><br><span class="line">                <span class="attr">"ipAddr"</span>: <span class="string">"192.168.0.106"</span>,</span><br><span class="line">                <span class="attr">"status"</span>: <span class="string">"UP"</span>,</span><br><span class="line">                <span class="attr">"overriddenStatus"</span>: <span class="string">"UNKNOWN"</span>,</span><br><span class="line">                <span class="attr">"port"</span>: &#123;</span><br><span class="line">                    <span class="attr">"$"</span>: <span class="number">8081</span>,</span><br><span class="line">                    <span class="attr">"@enabled"</span>: <span class="string">"true"</span></span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="attr">"securePort"</span>: &#123;</span><br><span class="line">                    <span class="attr">"$"</span>: <span class="number">443</span>,</span><br><span class="line">                    <span class="attr">"@enabled"</span>: <span class="string">"false"</span></span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="attr">"countryId"</span>: <span class="number">1</span>,</span><br><span class="line">                <span class="attr">"dataCenterInfo"</span>: &#123;</span><br><span class="line">                    <span class="attr">"@class"</span>: <span class="string">"com.netflix.appinfo.InstanceInfo$DefaultDataCenterInfo"</span>,</span><br><span class="line">                    <span class="attr">"name"</span>: <span class="string">"MyOwn"</span></span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="attr">"leaseInfo"</span>: &#123;</span><br><span class="line">                    <span class="attr">"renewalIntervalInSecs"</span>: <span class="number">5</span>,</span><br><span class="line">                    <span class="attr">"durationInSecs"</span>: <span class="number">5</span>,</span><br><span class="line">                    <span class="attr">"registrationTimestamp"</span>: <span class="number">1588138533939</span>,</span><br><span class="line">                    <span class="attr">"lastRenewalTimestamp"</span>: <span class="number">1588140045949</span>,</span><br><span class="line">                    <span class="attr">"evictionTimestamp"</span>: <span class="number">0</span>,</span><br><span class="line">                    <span class="attr">"serviceUpTimestamp"</span>: <span class="number">1588138533939</span></span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="attr">"metadata"</span>: &#123;</span><br><span class="line">                    <span class="attr">"management.port"</span>: <span class="string">"8081"</span></span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="attr">"homePageUrl"</span>: <span class="string">"http://192.168.0.106:8081/"</span>,</span><br><span class="line">                <span class="attr">"statusPageUrl"</span>: <span class="string">"https://wu_zhiyong.gitee.io/myblog/"</span>,</span><br><span class="line">                <span class="attr">"healthCheckUrl"</span>: <span class="string">"http://192.168.0.106:8081/actuator/health"</span>,</span><br><span class="line">                <span class="attr">"vipAddress"</span>: <span class="string">"eureka-client-user-service"</span>,</span><br><span class="line">                <span class="attr">"secureVipAddress"</span>: <span class="string">"eureka-client-user-service"</span>,</span><br><span class="line">                <span class="attr">"isCoordinatingDiscoveryServer"</span>: <span class="string">"false"</span>,</span><br><span class="line">                <span class="attr">"lastUpdatedTimestamp"</span>: <span class="string">"1588138533939"</span>,</span><br><span class="line">                <span class="attr">"lastDirtyTimestamp"</span>: <span class="string">"1588138533909"</span>,</span><br><span class="line">                <span class="attr">"actionType"</span>: <span class="string">"ADDED"</span></span><br><span class="line">            &#125;</span><br><span class="line">        ]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="元数据使用"><a href="#元数据使用" class="headerlink" title="元数据使用"></a>元数据使用</h4><blockquote>
<p>Eureka的元数据有两种类型，分别是框架定好了的标准元数据和用户自定义元数据标准元数据指的是主机名、IP地址、端口号、状态页和健康检查等信息，这些信息都会被发布在服务注册表中，用于服务之间的调用。自定义元数据可以使用 eureka. Instance metadatamap进行配置。</p>
<p>自定义元数据说得通俗点就是自定义配置，我们可以为每个 Eureka Client定义一些属于自己的配置，这个配置不会影响 Eureka的功能。自定义元数据可以用来做一些扩展信息，比如灰度发布之类的功能，可以用元数据来存储灰度发布的状态数据， Ribbon转发的时候就可以根据服务的元数据来做一些处理。当不需要灰度发布的时候可以调用 Eureka提供的 REST API将元数据清除掉。</p>
<p align="right">——《spring cloud 微服务 入门、进阶与实战》第47页<p>
</blockquote>
<p>下面我们来自定义一个简单的元数据，在属性文件中配置如下</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#配置元数据(不同版本有细微的差别，可通过提示来选择)</span></span><br><span class="line"><span class="meta">eureka.instance.metadata-map.create-user</span>=<span class="string">WuZhiYong</span></span><br></pre></td></tr></table></figure>

<p>然后再次通过postman 来请上面的rest api 地址</p>
<p>我们定义的元数据已经呈现出来了</p>
<img data-src="/myblog/%E4%BD%BF%E7%94%A8Eureka%E7%BC%96%E5%86%99%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83%E6%9C%8D%E5%8A%A1/image-20200429141503793.png" class="">

<h4 id="EurekaClient-使用"><a href="#EurekaClient-使用" class="headerlink" title="EurekaClient 使用"></a>EurekaClient 使用</h4><p>当我们项目中集成了Eureka之后，可以通过EurekaClient来获取一些我们想要的数据，比如上面的元数据，我们就可以直接通过EurekaClient来获取。</p>
<p>首先我们在server-cunsumer 的controller 中加入下面代码并重启</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Qualifier</span>(<span class="string">"eurekaClient"</span>)</span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> EurekaClient eurekaClient;</span><br><span class="line"></span><br><span class="line"><span class="meta">@GetMapping</span>(<span class="string">"/article/info"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">serviceUrl</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> eurekaClient.getInstancesByVipAddress(<span class="string">"eureka-client-user-service"</span>,<span class="keyword">false</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后通过postman请求可以得到相同的结果：(server-cunsumer没有认证所以这里直接访问即可)</p>
<img data-src="/myblog/%E4%BD%BF%E7%94%A8Eureka%E7%BC%96%E5%86%99%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83%E6%9C%8D%E5%8A%A1/image-20200429142503537.png" class="">

<h4 id="健康检查"><a href="#健康检查" class="headerlink" title="健康检查"></a>健康检查</h4><blockquote>
<p>默认情况下， Eureka客户端是使用心跳和服务端通信来判断客户端是否存活，在某些场景下，比如 Mongodb出现了异常，但你的应用进程还是存在的，这就意味着应用可以继续通过心跳上报，保持应用自己的信息在 Eureka中不被剔除掉。</p>
<p>Spring Boot Actuator提供了/ actuator/ health端点，该端点可展示应用程序的健康信息，当 MONGODB异常时，/ actuator/health端点的状态会变成DOWN，由于应用本身确实处于存活状态，但是 Mongodb的异常会影响某些功能，当请求到达应用之后会发生操作失败的</p>
<p>情况。</p>
<p>在这种情况下，我们希望可以将健康信息传递给 Eureka服务端。这样 Eureka中就能及时将应用的实例信息下线，隔离正常请求，防止出错。通过配置如下内容开启健康检查</p>
<p>eureka. client healthcheck. enabled-true</p>
<p>我们可以通过扩展健康检查的端点来模拟异常情况，定义一个扩展端点，将状态设置为DOWN</p>
<p align="right">——《spring cloud 微服务 入门、进阶与实战》第49页<p>
</blockquote>
<p>我们在server-consumer application.properties中开启健康检查：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#开启健康检查（可以让注册中心获取检查状态）</span></span><br><span class="line"><span class="meta">eureka.client.healthcheck.enabled</span>=<span class="string">true</span></span><br></pre></td></tr></table></figure>

<p>当然前提需要添加依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>自定义类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyHealthIndicator</span> <span class="keyword">extends</span> <span class="title">AbstractHealthIndicator</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doHealthCheck</span><span class="params">(Health.Builder builder)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        builder.down().withDetail(<span class="string">"status"</span>,<span class="keyword">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>重启后访问注册中心</p>
<img data-src="/myblog/%E4%BD%BF%E7%94%A8Eureka%E7%BC%96%E5%86%99%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83%E6%9C%8D%E5%8A%A1/image-20200429144244592.png" class="">

<h4 id="服务上下线监控"><a href="#服务上下线监控" class="headerlink" title="服务上下线监控"></a>服务上下线监控</h4><blockquote>
<p>在某些特定的需求下，我们需要对服务的上下线进行监控，上线或下线都进行邮件通知， Eureka中提供了事件监听的方式来扩展。</p>
<p>目前支持的事件如下：</p>
<ul>
<li><p>EurekalnstanceCanceledEvent服务下线事件。</p>
</li>
<li><p>EurekalnstanceRegisteredEvent服务注册事件。</p>
</li>
<li><p>EurekalnstanceRenewedEvent服务续约事件。</p>
</li>
<li><p>EurekaRegistry AvailableEvent Eureka注册中心启动事件。</p>
</li>
<li><p>EurekaServerStartedEvent Eureka Server启动事件。</p>
</li>
</ul>
<p>基于 Eureka提供的事件机制，可以监控服务的上下线过程，在过程发生中可以发送邮</p>
<p align="right">——《spring cloud 微服务 入门、进阶与实战》第50页<p>
</blockquote>
<p>我们在注册中心Eureka-server的项目里加上下面代码：（集群就每个集群项目里加上）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EurekaStateChangeListener</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@EventListener</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">listen</span><span class="params">(EurekaInstanceCanceledEvent event)</span> </span>&#123;</span><br><span class="line">      <span class="comment">//发送邮件。。。</span></span><br><span class="line">      <span class="comment">//发送短信。。。</span></span><br><span class="line">        System.err.println(event.getServerId() + <span class="string">"\t"</span> + event.getAppName() + <span class="string">" 服务下线"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@EventListener</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">listen</span><span class="params">(EurekaInstanceRegisteredEvent event)</span> </span>&#123;</span><br><span class="line">        InstanceInfo instanceInfo = event.getInstanceInfo();</span><br><span class="line">        System.err.println(instanceInfo.getAppName() + <span class="string">"进行注册"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@EventListener</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">listen</span><span class="params">(EurekaInstanceRenewedEvent event)</span> </span>&#123;</span><br><span class="line">        System.err.println(event.getServerId() + <span class="string">"\t"</span> + event.getAppName() + <span class="string">" 服务进行续约"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@EventListener</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">listen</span><span class="params">(EurekaRegistryAvailableEvent event)</span> </span>&#123;</span><br><span class="line">        System.err.println(<span class="string">"注册中心 启动"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@EventListener</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">listen</span><span class="params">(EurekaServerStartedEvent event)</span> </span>&#123;</span><br><span class="line">        System.err.println(<span class="string">"Eureka Server 启动"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>注意</p>
<p>注在 Eureka集群环境下，每个节点都会触发事件，这个时侯需要控制下发送通知的行为，不控制的话每个节点都会发送通知。</p>
</blockquote>
<p>重启后控制台：</p>
<img data-src="/myblog/%E4%BD%BF%E7%94%A8Eureka%E7%BC%96%E5%86%99%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83%E6%9C%8D%E5%8A%A1/image-20200429152545740.png" class="">
    </div>

    
    
    
        <div class="reward-container">
  <div></div>
  <button onclick="var qr = document.getElementById('qr'); qr.style.display = (qr.style.display === 'none') ? 'block' : 'none';">
    打赏
  </button>
  <div id="qr" style="display: none;">
      
      <div style="display: inline-block;">
        <img src="https://gitee.com/wu_zhiyong/pic-bed/raw/master/img/微信图片_20200501220918.png" alt="wuzhiyong 微信支付">
        <p>微信支付</p>
      </div>
      
      <div style="display: inline-block;">
        <img src="https://gitee.com/wu_zhiyong/pic-bed/raw/master/img/微信图片_20200501220907.jpg" alt="wuzhiyong 支付宝">
        <p>支付宝</p>
      </div>

  </div>
</div>


      <footer class="post-footer">
          <div class="post-tags">
              <a href="/myblog/tags/springboot/" rel="tag"># springboot</a>
              <a href="/myblog/tags/java/" rel="tag"># java</a>
              <a href="/myblog/tags/spring-cloud/" rel="tag"># spring cloud</a>
              <a href="/myblog/tags/Eureka/" rel="tag"># Eureka</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/myblog/%E8%87%AA%E5%AE%9A%E4%B9%89Starter/" rel="prev" title="自定义Starter">
      <i class="fa fa-chevron-left"></i> 自定义Starter
    </a></div>
      <div class="post-nav-item">
    <a href="/myblog/%E5%AE%A2%E6%88%B7%E7%AB%AF%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1Ribbon/" rel="next" title="客户端负载均衡Ribbon">
      客户端负载均衡Ribbon <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          
    <div class="comments" id="valine-comments"></div>

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#引言"><span class="nav-number">1.</span> <span class="nav-text">引言</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#开始"><span class="nav-number">2.</span> <span class="nav-text">开始</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#服务提供者"><span class="nav-number">3.</span> <span class="nav-text">服务提供者</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#服务消费者"><span class="nav-number">4.</span> <span class="nav-text">服务消费者</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#开启Eureka认证"><span class="nav-number">5.</span> <span class="nav-text">开启Eureka认证</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#关闭自我保护"><span class="nav-number">6.</span> <span class="nav-text">关闭自我保护</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#自定义Eureka的实例（instanceId）ID"><span class="nav-number">7.</span> <span class="nav-text">自定义Eureka的实例（instanceId）ID</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#自定义实例跳转链接"><span class="nav-number">8.</span> <span class="nav-text">自定义实例跳转链接</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#快速移除已失效的服务信息"><span class="nav-number">9.</span> <span class="nav-text">快速移除已失效的服务信息</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Eureka高可用搭建"><span class="nav-number">10.</span> <span class="nav-text">Eureka高可用搭建</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#高可用原理"><span class="nav-number">10.1.</span> <span class="nav-text">高可用原理</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#搭建步骤"><span class="nav-number">10.2.</span> <span class="nav-text">搭建步骤</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#扩展使用"><span class="nav-number">11.</span> <span class="nav-text">扩展使用</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Eureka-REST-API"><span class="nav-number">11.1.</span> <span class="nav-text">Eureka REST API</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#元数据使用"><span class="nav-number">11.2.</span> <span class="nav-text">元数据使用</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#EurekaClient-使用"><span class="nav-number">11.3.</span> <span class="nav-text">EurekaClient 使用</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#健康检查"><span class="nav-number">11.4.</span> <span class="nav-text">健康检查</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#服务上下线监控"><span class="nav-number">11.5.</span> <span class="nav-text">服务上下线监控</span></a></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">wuzhiyong</p>
  <div class="site-description" itemprop="description">吴志勇的博客</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/myblog/archives/">
        
          <span class="site-state-item-count">37</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/myblog/categories/">
          
        <span class="site-state-item-count">9</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/myblog/tags/">
          
        <span class="site-state-item-count">33</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="mailto:wzy563653092@gmail.com" title="E-Mail → mailto:wzy563653092@gmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">wuzhiyong</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
    <span title="站点总字数">246k</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">3:43</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> 强力驱动
  </div>
  <div class="addthis_inline_share_toolbox">
    <script src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5eae29bdce1a511b" async="async"></script>
  </div>

        






<script>
  (function() {
    function leancloudSelector(url) {
      url = encodeURI(url);
      return document.getElementById(url).querySelector('.leancloud-visitors-count');
    }

    function addCount(Counter) {
      var visitors = document.querySelector('.leancloud_visitors');
      var url = decodeURI(visitors.id);
      var title = visitors.dataset.flagTitle;

      Counter('get', '/classes/Counter?where=' + encodeURIComponent(JSON.stringify({ url })))
        .then(response => response.json())
        .then(({ results }) => {
          if (results.length > 0) {
            var counter = results[0];
            leancloudSelector(url).innerText = counter.time + 1;
            Counter('put', '/classes/Counter/' + counter.objectId, { time: { '__op': 'Increment', 'amount': 1 } })
              .catch(error => {
                console.error('Failed to save visitor count', error);
              });
          } else {
              Counter('post', '/classes/Counter', { title, url, time: 1 })
                .then(response => response.json())
                .then(() => {
                  leancloudSelector(url).innerText = 1;
                })
                .catch(error => {
                  console.error('Failed to create', error);
                });
          }
        })
        .catch(error => {
          console.error('LeanCloud Counter Error', error);
        });
    }

    function showTime(Counter) {
      var visitors = document.querySelectorAll('.leancloud_visitors');
      var entries = [...visitors].map(element => {
        return decodeURI(element.id);
      });

      Counter('get', '/classes/Counter?where=' + encodeURIComponent(JSON.stringify({ url: { '$in': entries } })))
        .then(response => response.json())
        .then(({ results }) => {
          for (let url of entries) {
            let target = results.find(item => item.url === url);
            leancloudSelector(url).innerText = target ? target.time : 0;
          }
        })
        .catch(error => {
          console.error('LeanCloud Counter Error', error);
        });
    }

    let { app_id, app_key, server_url } = {"enable":true,"app_id":"jOjNqcMeMLL4ntoMdf13veTb-MdYXbMMI","app_key":"v50rUeYs7yeT6hECN7XAhYYM","server_url":null,"security":false};
    function fetchData(api_server) {
      var Counter = (method, url, data) => {
        return fetch(`${api_server}/1.1${url}`, {
          method,
          headers: {
            'X-LC-Id'     : app_id,
            'X-LC-Key'    : app_key,
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(data)
        });
      };
      if (CONFIG.page.isPost) {
        // if (CONFIG.hostname !== location.hostname) return;
        addCount(Counter);
      } else if (document.querySelectorAll('.post-title-link').length >= 1) {
        showTime(Counter);
      }
    }

    let api_server = app_id.slice(-9) !== '-MdYXbMMI' ? server_url : `https://${app_id.slice(0, 8).toLowerCase()}.api.lncldglobal.com`;

    if (api_server) {
      fetchData(api_server);
    } else {
      fetch('https://app-router.leancloud.cn/2/route?appId=' + app_id)
        .then(response => response.json())
        .then(({ api_server }) => {
          fetchData('https://' + api_server);
        });
    }
  })();
</script>


      </div>
    </footer>
  </div>

  
  <script src="/myblog/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script>
  <script src="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/lozad@1/dist/lozad.min.js"></script>
  <script src="/myblog/lib/velocity/velocity.min.js"></script>
  <script src="/myblog/lib/velocity/velocity.ui.min.js"></script>

<script src="/myblog/js/utils.js"></script>

<script src="/myblog/js/motion.js"></script>


<script src="/myblog/js/schemes/muse.js"></script>


<script src="/myblog/js/next-boot.js"></script>




  




  
<script src="/myblog/js/local-search.js"></script>













  

  


<script>
NexT.utils.loadComments(document.querySelector('#valine-comments'), () => {
  NexT.utils.getScript('//unpkg.com/valine/dist/Valine.min.js', () => {
    var GUEST = ['nick', 'mail', 'link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item => {
      return GUEST.includes(item);
    });
    new Valine({
      el         : '#valine-comments',
      verify     : false,
      notify     : false,
      appId      : 'jOjNqcMeMLL4ntoMdf13veTb-MdYXbMMI',
      appKey     : 'v50rUeYs7yeT6hECN7XAhYYM',
      placeholder: "Just go go",
      avatar     : 'mm',
      meta       : guest,
      pageSize   : '10' || 10,
      visitor    : false,
      lang       : 'zh-cn' || 'zh-cn',
      path       : location.pathname,
      recordIP   : false,
      serverURLs : ''
    });
  }, window.Valine);
});
</script>

</body>
</html>
