<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.1">
  <link rel="apple-touch-icon" sizes="180x180" href="/blog.github.io/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/blog.github.io/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/blog.github.io/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/blog.github.io/images/logo.svg" color="#222">

<link rel="stylesheet" href="/blog.github.io/css/main.css">


<link rel="stylesheet" href="/blog.github.io/lib/font-awesome/css/all.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"wuzhiyong1759.github.io","root":"/blog.github.io/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":true,"mediumzoom":false,"lazyload":true,"pangu":false,"comments":{"style":"tabs","active":null,"storage":false,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="必要条件 一台可通过公网地址访问的服务器 服务器可在阿里云或腾讯云购买。  一个具有支付接口权限的公众号 公众号自然是在 ‘微信公众平台’ 申请。具有支付权限的公众号得注册为企业级公众号（或称为服务号），并且通过了企业认证。企业认证需要机关单位或企业门店的 ‘营业执照’ 。在公司的话可使用公司营业执照。如果是个人，除了借别人的就只能自己去办一个了。（我就是自己去申请办理了 “个体工商户营业执照”。">
<meta property="og:type" content="article">
<meta property="og:title" content="微信支付-JSAPI">
<meta property="og:url" content="https://wuzhiyong1759.github.io/%E5%BE%AE%E4%BF%A1%E6%94%AF%E4%BB%98-JSAPI/index.html">
<meta property="og:site_name" content="吴志勇的博客">
<meta property="og:description" content="必要条件 一台可通过公网地址访问的服务器 服务器可在阿里云或腾讯云购买。  一个具有支付接口权限的公众号 公众号自然是在 ‘微信公众平台’ 申请。具有支付权限的公众号得注册为企业级公众号（或称为服务号），并且通过了企业认证。企业认证需要机关单位或企业门店的 ‘营业执照’ 。在公司的话可使用公司营业执照。如果是个人，除了借别人的就只能自己去办一个了。（我就是自己去申请办理了 “个体工商户营业执照”。">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://wuzhiyong1759.github.io/%E5%BE%AE%E4%BF%A1%E6%94%AF%E4%BB%98-JSAPI/%E5%BE%AE%E4%BF%A1%E6%94%AF%E4%BB%98-JSAPI/0">
<meta property="og:image" content="https://gitee.com/wu_zhiyong/pic-bed/raw/master/img/image-20210304235456875.png">
<meta property="og:image" content="https://gitee.com/wu_zhiyong/pic-bed/raw/master/img/image-20210305104608204.png">
<meta property="og:image" content="https://gitee.com/wu_zhiyong/pic-bed/raw/master/img/image-20210305162815211.png">
<meta property="og:image" content="https://gitee.com/wu_zhiyong/pic-bed/raw/master/img/image-20210305165240649.png">
<meta property="og:image" content="https://gitee.com/wu_zhiyong/pic-bed/raw/master/img/image-20210305165514980.png">
<meta property="og:image" content="https://gitee.com/wu_zhiyong/pic-bed/raw/master/img/image-20210305165854877.png">
<meta property="article:published_time" content="2021-03-04T08:00:58.000Z">
<meta property="article:modified_time" content="2021-03-05T09:04:33.710Z">
<meta property="article:author" content="wuzhiyong">
<meta property="article:tag" content="springboot">
<meta property="article:tag" content="java">
<meta property="article:tag" content="微信">
<meta property="article:tag" content="支付">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://wuzhiyong1759.github.io/%E5%BE%AE%E4%BF%A1%E6%94%AF%E4%BB%98-JSAPI/%E5%BE%AE%E4%BF%A1%E6%94%AF%E4%BB%98-JSAPI/0">

<link rel="canonical" href="https://wuzhiyong1759.github.io/%E5%BE%AE%E4%BF%A1%E6%94%AF%E4%BB%98-JSAPI/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>微信支付-JSAPI | 吴志勇的博客</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/blog.github.io/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">吴志勇的博客</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">学习、记录、总结、侃大山</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/blog.github.io/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/blog.github.io/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/blog.github.io/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/blog.github.io/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://wuzhiyong1759.github.io/%E5%BE%AE%E4%BF%A1%E6%94%AF%E4%BB%98-JSAPI/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog.github.io/images/avatar.gif">
      <meta itemprop="name" content="wuzhiyong">
      <meta itemprop="description" content="吴志勇的博客">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="吴志勇的博客">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          微信支付-JSAPI
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-03-04 16:00:58" itemprop="dateCreated datePublished" datetime="2021-03-04T16:00:58+08:00">2021-03-04</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-03-05 17:04:33" itemprop="dateModified" datetime="2021-03-05T17:04:33+08:00">2021-03-05</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog.github.io/categories/%E7%BC%96%E7%A8%8B/" itemprop="url" rel="index"><span itemprop="name">编程</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog.github.io/categories/%E7%BC%96%E7%A8%8B/%E5%90%8E%E7%AB%AF/" itemprop="url" rel="index"><span itemprop="name">后端</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog.github.io/categories/%E7%BC%96%E7%A8%8B/%E5%90%8E%E7%AB%AF/java/" itemprop="url" rel="index"><span itemprop="name">java</span></a>
                </span>
            </span>

          
            <span id="/blog.github.io/%E5%BE%AE%E4%BF%A1%E6%94%AF%E4%BB%98-JSAPI/" class="post-meta-item leancloud_visitors" data-flag-title="微信支付-JSAPI" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/blog.github.io/%E5%BE%AE%E4%BF%A1%E6%94%AF%E4%BB%98-JSAPI/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/blog.github.io/%E5%BE%AE%E4%BF%A1%E6%94%AF%E4%BB%98-JSAPI/" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>15k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>13 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h3 id="必要条件"><a href="#必要条件" class="headerlink" title="必要条件"></a>必要条件</h3><ul>
<li><p><strong>一台可通过公网地址访问的服务器</strong></p>
<p>服务器可在阿里云或腾讯云购买。</p>
</li>
<li><p><strong>一个具有支付接口权限的公众号</strong></p>
<p>公众号自然是在 ‘微信公众平台’ 申请。具有支付权限的公众号得注册为企业级公众号（或称为服务号），并且通过了企业认证。企业认证需要机关单位或企业门店的 ‘营业执照’ 。在公司的话可使用公司营业执照。如果是个人，除了借别人的就只能自己去办一个了。（我就是自己去申请办理了 “个体工商户营业执照”。办理这个营业执照需要房屋或经营场所的产权使用证明和身份证。房屋使用证明可以是购房合同，和租赁合同，或产权证和产权所有方手写的一张授权使用证明。办理地点就在经营场所所在当地的市场监督管理局，一般一周就能办理下来。办理下来后根据规定得去当地的税务局办理税务登记手续，然后就可以去正规的刻章店刻章了，这时候你这个个体户也就是小企业可以开张了。公众号有了营业执照和公章就足以办理企业认证了。当然如果你办公场地装修好了也有人上岗办公了那么这个时候可以去银行开通一个对公账户。微信支付可用的上，没有的话也没关系微信支付也可以填写私人银行账户。另外：办理税务登记后记得每个季度去办理税务申报，可在网上办理也可直接去税务局办理。逾期没办的税务局会打电话给你，有可能会影响企业信誉）</p>
<p>听说前段时间微信给个人公众号也开放的支付功能，我还没去看相关文档。</p>
</li>
<li><p><strong>一个已经通过了备案的域名</strong></p>
<p>域名和服务器一样可在阿里或腾讯购买。（不过我忘了域名备案需要些什么东西了）</p>
</li>
<li><p><strong>具有一定的前后端开发能力以及服务器搭建能力</strong></p>
</li>
</ul>
<h3 id="实现步骤"><a href="#实现步骤" class="headerlink" title="实现步骤"></a>实现步骤</h3><h4 id="首要目标"><a href="#首要目标" class="headerlink" title="首要目标"></a>首要目标</h4><p>在微信的小程序或公众号内的支付场景中，除了业务上的一些交互外往往最终付款的时候我们就是通过一个按钮 “结算” 或 “付款” 来唤起支付页面。然后输入密码，成功后就跳转到支付成功的页面。事实上也是如此。通过微信开放文档得知唤起支付页面就是下面这段 js 代码</p>
<blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//文档地址：https://developers.weixin.qq.com/doc/offiaccount/OA_Web_Apps/JS-SDK.html#58</span></span><br><span class="line">wx.chooseWXPay(&#123;</span><br><span class="line">  timestamp: <span class="number">0</span>, <span class="comment">// 支付签名时间戳，注意微信jssdk中的所有使用timestamp字段均为小写。但最新版的支付后台生成签名使用的timeStamp字段名需大写其中的S字符</span></span><br><span class="line">  nonceStr: <span class="string">''</span>, <span class="comment">// 支付签名随机串，不长于 32 位</span></span><br><span class="line">  package: <span class="string">''</span>, <span class="comment">// 统一支付接口返回的prepay_id参数值，提交格式如：prepay_id=\*\*\*）</span></span><br><span class="line">  signType: <span class="string">''</span>, <span class="comment">// 签名方式，默认为'SHA1'，使用新版支付需传入'MD5'</span></span><br><span class="line">  paySign: <span class="string">''</span>, <span class="comment">// 支付签名</span></span><br><span class="line">  success: <span class="function"><span class="keyword">function</span> (<span class="params">res</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 支付成功后的回调函数（跳转到支付成功页面等操作）</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
</blockquote>
<p>我们的<strong>目标</strong>就是要这段代码能够完美的得到执行。</p>
<p>通过阅读文档发现这段 js 需要的参数package prepay_id 得通过统一下单接口才能拿到。而调用统一下单接口又有一个关键参数 openId 而这个 openId 得通过网页授权才能拿到。</p>
<p>网页授权的前提又必须开启公众号的开发者模式。开启开发者模式可参看本博客文章 <a href="https://wu_zhiyong.gitee.io/myblog/%E5%BE%AE%E4%BF%A1%E5%85%AC%E4%BC%97%E5%8F%B7%EF%BC%88%E6%9C%8D%E5%8A%A1%E5%8F%B7%EF%BC%89%E9%85%8D%E7%BD%AE%E6%9C%8D%E5%8A%A1%E5%99%A8/" target="_blank" rel="noopener">微信公众号配置服务器</a><a id="more"></a></p>
<h4 id="第一步：网页授权"><a href="#第一步：网页授权" class="headerlink" title="第一步：网页授权"></a>第一步：网页授权</h4><p><strong>网页授权又分为如下四步</strong></p>
<p>文档地址：<a href="https://developers.weixin.qq.com/doc/offiaccount/OA_Web_Apps/Wechat_webpage_authorization.html" target="_blank" rel="noopener">https://developers.weixin.qq.com/doc/offiaccount/OA_Web_Apps/Wechat_webpage_authorization.html</a></p>
<h5 id="引导用户进入授权页面同意授权，获取code"><a href="#引导用户进入授权页面同意授权，获取code" class="headerlink" title="引导用户进入授权页面同意授权，获取code"></a>引导用户进入授权页面同意授权，获取code</h5><p>​    执行窗口跳转 js 弹出授权页面</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> url = <span class="string">"https://open.weixin.qq.com/connect/oauth2/authorize?appid=wxf0e81c3bee622d60&amp;redirect_uri=http%3A%2F%2Fnba.bluewebgame.com%2Foauth_response.php&amp;response_type=code&amp;scope=snsapi_userinfo&amp;state=STATE#wechat_redirect"</span></span><br><span class="line"><span class="built_in">window</span>.location.href = wxUrl;</span><br></pre></td></tr></table></figure>

<p><img data-src="%E5%BE%AE%E4%BF%A1%E6%94%AF%E4%BB%98-JSAPI/0" alt=""></p>
<table>
<thead>
<tr>
<th align="left">参数</th>
<th>是否必须</th>
<th align="center">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="left">appid</td>
<td>是</td>
<td align="center">公众号的唯一标识</td>
</tr>
<tr>
<td align="left">redirect_uri</td>
<td>是</td>
<td align="center">授权后重定向的回调链接地址， 请使用 urlEncode 对链接进行处理</td>
</tr>
<tr>
<td align="left">response_type</td>
<td>是</td>
<td align="center">返回类型，请填写code</td>
</tr>
<tr>
<td align="left">scope</td>
<td>是</td>
<td align="center">应用授权作用域，snsapi_base （不弹出授权页面，直接跳转，只能获取用户openid），snsapi_userinfo （弹出授权页面，可通过openid拿到昵称、性别、所在地。并且， 即使在未关注的情况下，只要用户授权，也能获取其信息 ）</td>
</tr>
<tr>
<td align="left">state</td>
<td>否</td>
<td align="center">重定向后会带上state参数，开发者可以填写a-zA-Z0-9的参数值，最多128字节</td>
</tr>
<tr>
<td align="left">#wechat_redirect</td>
<td>是</td>
<td align="center">无论直接打开还是做页面302重定向时候，必须带此参数</td>
</tr>
</tbody></table>
<p>appid：公众号 -&gt; 基本配置 -&gt; 公众号开发信息  开发者ID(AppID)</p>
<p>redirect_uri：为前端一个页面的地址。用户同意授权后会重定向到这个地址并会在地址后面跟上 code 值。在这个地址页面中我们通过解析到地址的 code 值向后端发起请求获取 access_token 从而获取到 openid</p>
<blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// vue 可通过 route 组件快速获取到 code 值</span></span><br><span class="line"><span class="keyword">let</span> code = <span class="keyword">this</span>.$route.query.code;</span><br><span class="line">alert(code);</span><br></pre></td></tr></table></figure>
</blockquote>
<h5 id="通过code换取网页授权access-token"><a href="#通过code换取网页授权access-token" class="headerlink" title="通过code换取网页授权access_token"></a>通过code换取网页授权access_token</h5><p>​    获取code后，请求以下链接获取access_token： <a href="https://api.weixin.qq.com/sns/oauth2/access_token?appid=APPID&amp;secret=SECRET&amp;code=CODE&amp;grant_type=authorization_code" target="_blank" rel="noopener">https://api.weixin.qq.com/sns/oauth2/access_token?appid=APPID&amp;secret=SECRET&amp;code=CODE&amp;grant_type=authorization_code</a></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// java 使用 fegin 请求 http 接口    </span></span><br><span class="line"><span class="meta">@RequestLine</span>(<span class="string">"GET /sns/oauth2/access_token?appid=&#123;appId&#125;&amp;secret=&#123;secret&#125;&amp;code=&#123;code&#125;&amp;grant_type=authorization_code"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getWebPageAccessToken</span><span class="params">(@Param(<span class="string">"appId"</span>)</span> String appId,</span></span><br><span class="line"><span class="function">                                            @<span class="title">Param</span><span class="params">(<span class="string">"secret"</span>)</span> String secret,</span></span><br><span class="line"><span class="function">                                            @<span class="title">Param</span><span class="params">(<span class="string">"code"</span>)</span> String code</span></span><br><span class="line"><span class="function">)</span>;</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th align="left">参数</th>
<th align="left">是否必须</th>
<th align="left">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="left">appid</td>
<td align="left">是</td>
<td align="left">公众号的唯一标识</td>
</tr>
<tr>
<td align="left">secret</td>
<td align="left">是</td>
<td align="left">公众号的appsecret</td>
</tr>
<tr>
<td align="left">code</td>
<td align="left">是</td>
<td align="left">填写第一步获取的code参数</td>
</tr>
<tr>
<td align="left">grant_type</td>
<td align="left">是</td>
<td align="left">填写为authorization_code</td>
</tr>
</tbody></table>
<p>secret：公众号 -&gt; 基本配置 -&gt; 公众号开发信息  开发者密码(AppSecret)     ps： 没有的话根据提示设定下就可以了</p>
<p>接口成功返回如下：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"access_token"</span>:<span class="string">"ACCESS_TOKEN"</span>,</span><br><span class="line">  <span class="attr">"expires_in"</span>:<span class="number">7200</span>,</span><br><span class="line">  <span class="attr">"refresh_token"</span>:<span class="string">"REFRESH_TOKEN"</span>,</span><br><span class="line">  <span class="attr">"openid"</span>:<span class="string">"OPENID"</span>,</span><br><span class="line">  <span class="attr">"scope"</span>:<span class="string">"SCOPE"</span> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th align="left">参数</th>
<th align="left">描述</th>
</tr>
</thead>
<tbody><tr>
<td align="left">access_token</td>
<td align="left">网页授权接口调用凭证,注意：此access_token与基础支持的access_token不同</td>
</tr>
<tr>
<td align="left">expires_in</td>
<td align="left">access_token接口调用凭证超时时间，单位（秒）</td>
</tr>
<tr>
<td align="left">refresh_token</td>
<td align="left">用户刷新access_token</td>
</tr>
<tr>
<td align="left">openid</td>
<td align="left">用户唯一标识，请注意，在未关注公众号时，用户访问公众号的网页，也会产生一个用户和公众号唯一的OpenID</td>
</tr>
<tr>
<td align="left">scope</td>
<td align="left">用户授权的作用域，使用逗号（,）分隔</td>
</tr>
</tbody></table>
<p><strong>如果需要，开发者可以刷新网页授权access_token，避免过期</strong></p>
<p>由于access_token拥有较短的有效期，当access_token超时后，可以使用refresh_token进行刷新，refresh_token有效期为30天，当refresh_token失效之后，需要用户重新授权。（这里建议 access_token 存放在 redis 中，利用 redis 过期回调机制来反复更新 token）</p>
<blockquote>
<p>获取第二步的refresh_token后，请求以下链接获取access_token： <a href="https://api.weixin.qq.com/sns/oauth2/refresh_token?appid=APPID&amp;grant_type=refresh_token&amp;refresh_token=REFRESH_TOKEN" target="_blank" rel="noopener">https://api.weixin.qq.com/sns/oauth2/refresh_token?appid=APPID&amp;grant_type=refresh_token&amp;refresh_token=REFRESH_TOKEN</a></p>
</blockquote>
<table>
<thead>
<tr>
<th align="left">参数</th>
<th align="left">是否必须</th>
<th align="left">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="left">appid</td>
<td align="left">是</td>
<td align="left">公众号的唯一标识</td>
</tr>
<tr>
<td align="left">grant_type</td>
<td align="left">是</td>
<td align="left">填写为refresh_token</td>
</tr>
<tr>
<td align="left">refresh_token</td>
<td align="left">是</td>
<td align="left">填写通过access_token获取到的refresh_token参数</td>
</tr>
</tbody></table>
<p>正确时返回的JSON数据包如下：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123; </span><br><span class="line">  <span class="attr">"access_token"</span>:<span class="string">"ACCESS_TOKEN"</span>,</span><br><span class="line">  <span class="attr">"expires_in"</span>:<span class="number">7200</span>,</span><br><span class="line">  <span class="attr">"refresh_token"</span>:<span class="string">"REFRESH_TOKEN"</span>,</span><br><span class="line">  <span class="attr">"openid"</span>:<span class="string">"OPENID"</span>,</span><br><span class="line">  <span class="attr">"scope"</span>:<span class="string">"SCOPE"</span> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>通过网页授权access_token和openid获取用户基本信息（支持UnionID机制）</strong></p>
<p>如果网页授权作用域为snsapi_userinfo，则此时开发者可以通过access_token和openid拉取用户信息了。</p>
<p>请求方法</p>
<blockquote>
<p>http：GET（请使用https协议） <a href="https://api.weixin.qq.com/sns/userinfo?access_token=ACCESS_TOKEN&amp;openid=OPENID&amp;lang=zh_CN" target="_blank" rel="noopener">https://api.weixin.qq.com/sns/userinfo?access_token=ACCESS_TOKEN&amp;openid=OPENID&amp;lang=zh_CN</a></p>
</blockquote>
<p>参数说明</p>
<table>
<thead>
<tr>
<th align="left">参数</th>
<th align="left">描述</th>
</tr>
</thead>
<tbody><tr>
<td align="left">access_token</td>
<td align="left">网页授权接口调用凭证,注意：此access_token与基础支持的access_token不同</td>
</tr>
<tr>
<td align="left">openid</td>
<td align="left">用户的唯一标识</td>
</tr>
<tr>
<td align="left">lang</td>
<td align="left">返回国家地区语言版本，zh_CN 简体，zh_TW 繁体，en 英语</td>
</tr>
</tbody></table>
<p>返回说明</p>
<p>正确时返回的JSON数据包如下：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#123;   </span><br><span class="line">  <span class="attr">"openid"</span>: <span class="string">"OPENID"</span>,</span><br><span class="line">  <span class="attr">"nickname"</span>: NICKNAME,</span><br><span class="line">  <span class="attr">"sex"</span>: <span class="number">1</span>,</span><br><span class="line">  <span class="attr">"province"</span>:<span class="string">"PROVINCE"</span>,</span><br><span class="line">  <span class="attr">"city"</span>:<span class="string">"CITY"</span>,</span><br><span class="line">  <span class="attr">"country"</span>:<span class="string">"COUNTRY"</span>,</span><br><span class="line">  <span class="attr">"headimgurl"</span>:<span class="string">"https://thirdwx.qlogo.cn/mmopen/g3MonUZtNHkdmzicIlibx6iaFqAc56vxLSUfpb6n5WKSYVY0ChQKkiaJSgQ1dZuTOgvLLrhJbERQQ4eMsv84eavHiaiceqxibJxCfHe/46"</span>,</span><br><span class="line">  <span class="attr">"privilege"</span>:[ <span class="string">"PRIVILEGE1"</span> <span class="string">"PRIVILEGE2"</span>     ],</span><br><span class="line">  <span class="attr">"unionid"</span>: <span class="string">"o6_bmasdasdsad6_2sgVt7hMZOPfL"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th align="left">参数</th>
<th align="left">描述</th>
</tr>
</thead>
<tbody><tr>
<td align="left">openid</td>
<td align="left">用户的唯一标识</td>
</tr>
<tr>
<td align="left">nickname</td>
<td align="left">用户昵称</td>
</tr>
<tr>
<td align="left">sex</td>
<td align="left">用户的性别，值为1时是男性，值为2时是女性，值为0时是未知</td>
</tr>
<tr>
<td align="left">province</td>
<td align="left">用户个人资料填写的省份</td>
</tr>
<tr>
<td align="left">city</td>
<td align="left">普通用户个人资料填写的城市</td>
</tr>
<tr>
<td align="left">country</td>
<td align="left">国家，如中国为CN</td>
</tr>
<tr>
<td align="left">headimgurl</td>
<td align="left">用户头像，最后一个数值代表正方形头像大小（有0、46、64、96、132数值可选，0代表640*640正方形头像），用户没有头像时该项为空。若用户更换头像，原有头像URL将失效。</td>
</tr>
<tr>
<td align="left">privilege</td>
<td align="left">用户特权信息，json 数组，如微信沃卡用户为（chinaunicom）</td>
</tr>
<tr>
<td align="left">unionid</td>
<td align="left">只有在用户将公众号绑定到微信开放平台帐号后，才会出现该字段。</td>
</tr>
</tbody></table>
<h4 id="第二步：-微信-js-sdk-初始化配置"><a href="#第二步：-微信-js-sdk-初始化配置" class="headerlink" title="第二步： 微信 js-sdk 初始化配置"></a>第二步： 微信 js-sdk 初始化配置</h4><p>通过网页授权我们已经可以拿到 openid 了。这时我们是否可以执行 wx.chooseWXPay  这个 js 了呢？还不行！这里有三个步骤还要做</p>
<p>文档地址：<a href="https://developers.weixin.qq.com/doc/offiaccount/OA_Web_Apps/JS-SDK.html#4" target="_blank" rel="noopener">https://developers.weixin.qq.com/doc/offiaccount/OA_Web_Apps/JS-SDK.html#4</a></p>
<h5 id="步骤一：绑定域名"><a href="#步骤一：绑定域名" class="headerlink" title="步骤一：绑定域名"></a>步骤一：绑定域名</h5><p>先登录微信公众平台进入“公众号设置”的“功能设置”里填写“JS接口安全域名”。</p>
<p><img data-src="https://gitee.com/wu_zhiyong/pic-bed/raw/master/img/image-20210304235456875.png" alt="image-20210304235456875"></p>
<p>这里根据提示操作下载证书配置即可。（这里的域名简单理解就是前端服务的域名）</p>
<p>备注：登录后可在“开发者中心”查看对应的接口权限。</p>
<h5 id="步骤二：引入JS文件"><a href="#步骤二：引入JS文件" class="headerlink" title="步骤二：引入JS文件"></a>步骤二：引入JS文件</h5><p>在需要调用JS接口的页面引入如下JS文件，（支持https）：<a href="http://res.wx.qq.com/open/js/jweixin-1.6.0.js" target="_blank" rel="noopener">http://res.wx.qq.com/open/js/jweixin-1.6.0.js</a></p>
<p>如需进一步提升服务稳定性，当上述资源不可访问时，可改访问：<a href="http://res2.wx.qq.com/open/js/jweixin-1.6.0.js" target="_blank" rel="noopener">http://res2.wx.qq.com/open/js/jweixin-1.6.0.js</a> （支持https）。</p>
<h5 id="步骤三：通过config接口注入权限验证配置"><a href="#步骤三：通过config接口注入权限验证配置" class="headerlink" title="步骤三：通过config接口注入权限验证配置"></a>步骤三：通过config接口注入权限验证配置</h5><p>所有需要使用JS-SDK的页面必须先注入配置信息，否则将无法调用（同一个url仅需调用一次，对于变化url的SPA的web app可在每次url变化时进行调用,目前Android微信客户端不支持pushState的H5新特性，所以使用pushState来实现web app的页面会导致签名失败，此问题会在Android6.2中修复）。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">wx.config(&#123;</span><br><span class="line">  debug: <span class="literal">true</span>, <span class="comment">// 开启调试模式,调用的所有api的返回值会在客户端alert出来，若要查看传入的参数，可以在pc端打开，参数信息会通过log打出，仅在pc端时才会打印。</span></span><br><span class="line">  appId: <span class="string">''</span>, <span class="comment">// 必填，公众号的唯一标识</span></span><br><span class="line">  timestamp: , <span class="comment">// 必填，生成签名的时间戳</span></span><br><span class="line">  nonceStr: <span class="string">''</span>, <span class="comment">// 必填，生成签名的随机串</span></span><br><span class="line">  signature: <span class="string">''</span>,<span class="comment">// 必填，签名</span></span><br><span class="line">  jsApiList: [] <span class="comment">// 必填，需要使用的JS接口列表 如只想调用支付js例：jsApiList: ['chooseWXPay']</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>wx.config 所需的参数需调后端接口返回。</p>
<p>(部分前端代码)</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> url = process.env.API_PROXY_ROOT+<span class="string">"/weixin/wx-config-signature"</span>;</span><br><span class="line"><span class="keyword">let</span> param_url = <span class="built_in">window</span>.location.href.split(<span class="string">"#"</span>)[<span class="number">0</span>];</span><br><span class="line">api.get(url,&#123;<span class="attr">params</span>:&#123;</span><br><span class="line">  openid:<span class="string">"openid"</span>,</span><br><span class="line">  url:param_url</span><br><span class="line">&#125;&#125;).then(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>(部分后端代码如下)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ApiResult <span class="title">getWXConfigSignature</span><span class="params">(HttpServletRequest request, String openid, String url)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">long</span> timeStampSec = System.currentTimeMillis() / <span class="number">1000</span>;</span><br><span class="line">        String timestamp = String.format(<span class="string">"%010d"</span>, timeStampSec);</span><br><span class="line">        String nonceStr = RandomString.make(<span class="number">8</span>);</span><br><span class="line">        String ticket = <span class="keyword">this</span>.getTicket(openid);</span><br><span class="line">        <span class="keyword">if</span> (ticket==<span class="keyword">null</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> ApiResult.fail(ResultCodeEnum.ERROR_WX_TOKEN_EXPIRED);</span><br><span class="line">        &#125;</span><br><span class="line">        log.info(<span class="string">"随机串："</span>+nonceStr+<span class="string">", 获取签名URL: "</span> + url);</span><br><span class="line">        JSONObject respJson = <span class="keyword">new</span> JSONObject();</span><br><span class="line">        String[] signArr = <span class="keyword">new</span> String[]&#123;<span class="string">"url="</span> + url, <span class="string">"jsapi_ticket="</span> + ticket, <span class="string">"noncestr="</span> + nonceStr, <span class="string">"timestamp="</span> + timestamp&#125;;</span><br><span class="line">        Arrays.sort(signArr);</span><br><span class="line">        String signStr = StringUtils.join(signArr, <span class="string">"&amp;"</span>);</span><br><span class="line">        System.out.println(<span class="string">"签名string!=："</span>+signStr);</span><br><span class="line">        String resSign = DigestUtils.sha1Hex(signStr);</span><br><span class="line"></span><br><span class="line">        log.info(<span class="string">"返回的签名："</span> + resSign);</span><br><span class="line">        respJson.put(<span class="string">"appId"</span>, appId);</span><br><span class="line">        respJson.put(<span class="string">"timestamp"</span>, timestamp);</span><br><span class="line">        respJson.put(<span class="string">"nonceStr"</span>, nonceStr);</span><br><span class="line">        respJson.put(<span class="string">"signature"</span>, resSign);</span><br><span class="line">        log.info(respJson.toString());</span><br><span class="line">        <span class="keyword">return</span> ApiResult.ok(respJson);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p><strong>签名算法</strong></p>
<p>签名生成规则如下：参与签名的字段包括noncestr（随机字符串）, 有效的jsapi_ticket, timestamp（时间戳）, url（当前网页的URL，不包含#及其后面部分） 。对所有待签名参数按照字段名的ASCII 码从小到大排序（字典序）后，使用URL键值对的格式（即key1=value1&amp;key2=value2…）拼接成字符串string1。这里需要注意的是所有参数名均为小写字符。对string1作sha1加密，字段名和字段值都采用原始值，不进行URL 转义。</p>
<p>即signature=sha1(string1)。 示例：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">noncestr</span>=<span class="string">Wm3WZYTPz0wzccnW</span></span><br><span class="line"><span class="attr">jsapi_ticket</span>=<span class="string">sM4AOVdWfPE4DxkXGEs8VMCPGGVi4C3VM0P37wVUCFvkVAy_90u5h9nbSlYy3-Sl-HhTdfl2fzFy1AOcHKP7qg</span></span><br><span class="line"><span class="attr">timestamp</span>=<span class="string">1414587457</span></span><br><span class="line"><span class="attr">url</span>=<span class="string">http://mp.weixin.qq.com?params=value</span></span><br></pre></td></tr></table></figure>

<p>步骤1. 对所有待签名参数按照字段名的ASCII 码从小到大排序（字典序）后，使用URL键值对的格式（即key1=value1&amp;key2=value2…）拼接成字符串string1：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jsapi_ticket&#x3D;sM4AOVdWfPE4DxkXGEs8VMCPGGVi4C3VM0P37wVUCFvkVAy_90u5h9nbSlYy3-Sl-HhTdfl2fzFy1AOcHKP7qg&amp;noncestr&#x3D;Wm3WZYTPz0wzccnW&amp;timestamp&#x3D;1414587457&amp;url&#x3D;http:&#x2F;&#x2F;mp.weixin.qq.com?params&#x3D;value</span><br></pre></td></tr></table></figure>

<p>步骤2. 对string1进行sha1签名，得到signature：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0f9de62fce790f9a083d5c99e95740ceb90c27ed</span><br></pre></td></tr></table></figure>

<p><strong>jsapi_ticket</strong></p>
<p>jsapi_ticket是公众号用于调用微信JS接口的临时票据。正常情况下，jsapi_ticket的有效期为7200秒，通过access_token来获取（注意这里的 token 不是前面网页授权的 token 详情参看文档）。由于获取jsapi_ticket的api调用次数非常有限，频繁刷新jsapi_ticket会导致api调用受限，影响自身业务，开发者必须在自己的服务全局缓存jsapi_ticket 。</p>
<ol>
<li>参考以下文档获取access_token（有效期7200秒，开发者必须在自己的服务全局缓存access_token）：<a href="https://developers.weixin.qq.com/doc/offiaccount/Basic_Information/Get_access_token.html" target="_blank" rel="noopener">https://developers.weixin.qq.com/doc/offiaccount/Basic_Information/Get_access_token.html</a></li>
<li>用第一步拿到的access_token 采用http GET方式请求获得jsapi_ticket（有效期7200秒，开发者必须在自己的服务全局缓存jsapi_ticket）：<a href="https://api.weixin.qq.com/cgi-bin/ticket/getticket?access_token=ACCESS_TOKEN&amp;type=jsapi" target="_blank" rel="noopener">https://api.weixin.qq.com/cgi-bin/ticket/getticket?access_token=ACCESS_TOKEN&amp;type=jsapi</a></li>
</ol>
<p>成功返回如下JSON：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"errcode"</span>:<span class="number">0</span>,</span><br><span class="line">  <span class="attr">"errmsg"</span>:<span class="string">"ok"</span>,</span><br><span class="line">  <span class="attr">"ticket"</span>:<span class="string">"bxLdikRXVbTPdHSM05e5u5sUoXNKd8-41ZO3MhKoyN5OfkWITDGgnr2fwJ0m9E8NYzWKVZvdVtaUgWvsdshFKA"</span>,</span><br><span class="line">  <span class="attr">"expires_in"</span>:<span class="number">7200</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>获得jsapi_ticket之后，就可以生成JS-SDK权限验证的签名了。</p>
<h4 id="第三步：唤起支付"><a href="#第三步：唤起支付" class="headerlink" title="第三步：唤起支付"></a>第三步：唤起支付</h4><p>终于到了  wx.chooseWXPay  的部分了。不过别高兴的太早，前面也说了调用这段 js 代码需要的 prepay_id  等参数我们需要提前准备好来，自然也是请求后端接口获取到喽。获取 prepay_id  的过程称之为 <strong>统一下单</strong></p>
<p>文档地址：<a href="https://pay.weixin.qq.com/wiki/doc/api/jsapi.php?chapter=9_1" target="_blank" rel="noopener">https://pay.weixin.qq.com/wiki/doc/api/jsapi.php?chapter=9_1</a></p>
<h5 id="统一下单"><a href="#统一下单" class="headerlink" title="统一下单"></a>统一下单</h5><p>在官方文档中统一下单的参数还是不少的。有了参数后还需要生成签名。生成完签名后参数 map 还得转成 xml 格式。这里微信提供了 java 版 demo 可以帮我们省去不少麻烦。</p>
<p>demo下载 文档地址：<a href="https://pay.weixin.qq.com/wiki/doc/api/jsapi.php?chapter=11_1" target="_blank" rel="noopener">https://pay.weixin.qq.com/wiki/doc/api/jsapi.php?chapter=11_1</a></p>
<p>java版下载解压后如下：</p>
<p><img data-src="https://gitee.com/wu_zhiyong/pic-bed/raw/master/img/image-20210305104608204.png" alt="image-20210305104608204"></p>
<p>根据个人喜好可以将 src 代码和 pom 依赖复制到项目使用。也可以用 maven 打个包后引入项目中使用。打包时可能会遇到一个错误，这是由于构建该项目的 maven 版本比较老导致的。百度下解决方法就是在 pom 的 build 标签里的内容用 pluginManagement 包裹下就好。<strong>另外注意</strong>打包前 需将源码 WXPayConfig 类中的 抽象方法都加上 public 修饰（不要问我为啥，你试过就知道）</p>
<p>在项目中使用的时候可参照 README.md 文件进行使用。算了还是贴下我的代码吧。他文件中说的不对 不是用 implements 而是用 extends 一些方法的实现也不全。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyConfig</span> <span class="keyword">extends</span> <span class="title">WXPayConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">byte</span>[] certData;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MyConfig</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        String certPath = <span class="string">""</span>;</span><br><span class="line"><span class="comment">//        String certPath = path_linux;</span></span><br><span class="line">        System.out.println(<span class="string">"path:=="</span>+certPath);</span><br><span class="line">        <span class="keyword">if</span> (IpAddressUtil.isWindowsOS())&#123;</span><br><span class="line"><span class="comment">//       证书文件登录商户平台申请和安装：https://pay.weixin.qq.com/index.php/core/cert/api_cert</span></span><br><span class="line">            certPath = <span class="string">"F:\\\\个人开发\\\\证书\\\\weixin\\\\WXCertUtil\\\\cert\\\\apiclient_cert.p12"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        File file = <span class="keyword">new</span> File(certPath);</span><br><span class="line">        InputStream certStream = <span class="keyword">new</span> FileInputStream(file);</span><br><span class="line">        <span class="keyword">this</span>.certData = <span class="keyword">new</span> <span class="keyword">byte</span>[(<span class="keyword">int</span>) file.length()];</span><br><span class="line">        certStream.read(<span class="keyword">this</span>.certData);</span><br><span class="line">        certStream.close();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getAppID</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="comment">//公众号 appid</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">"appId"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getMchID</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="comment">//登录商户平台获取：https://pay.weixin.qq.com/index.php/extend/employee</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">"商户id"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getKey</span><span class="params">()</span> </span>&#123;</span><br><span class="line">			<span class="comment">//登录商户平台设置：https://pay.weixin.qq.com/index.php/core/cert/api_cert</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">"商户api密钥"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> InputStream <span class="title">getCertStream</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        ByteArrayInputStream certBis = <span class="keyword">new</span> ByteArrayInputStream(<span class="keyword">this</span>.certData);</span><br><span class="line">        <span class="keyword">return</span> certBis;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getHttpConnectTimeoutMs</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">8000</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getHttpReadTimeoutMs</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">10000</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> IWXPayDomain <span class="title">getWXPayDomain</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        IWXPayDomain iwxPayDomain = <span class="keyword">new</span> IWXPayDomain() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">report</span><span class="params">(String domain, <span class="keyword">long</span> elapsedTimeMillis, Exception ex)</span> </span>&#123;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> DomainInfo <span class="title">getDomain</span><span class="params">(WXPayConfig config)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> IWXPayDomain.DomainInfo(WXPayConstants.DOMAIN_API, <span class="keyword">true</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">return</span> iwxPayDomain;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>除去上边配置的参数和非必填项，<strong>统一下单</strong>的参数大概有这些（不包括签名）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">Map&lt;String, String&gt; data = <span class="keyword">new</span> HashMap&lt;String, String&gt;();</span><br><span class="line"><span class="comment">//商品描述 自定义</span></span><br><span class="line">data.put(<span class="string">"body"</span>, <span class="string">"青云软件工作室会员充值"</span>);</span><br><span class="line"><span class="comment">//商户订单号（这里的订单号长度不能太短，不然会提示该参数无效。传 1 和 100 就能见效哦）</span></span><br><span class="line">data.put(<span class="string">"out_trade_no"</span>, <span class="string">"生成的订单号"</span>);</span><br><span class="line"><span class="comment">//设备号 自定义参数，可以为终端设备号(门店号或收银设备ID)，PC网页或公众号内支付可以传"WEB"</span></span><br><span class="line">data.put(<span class="string">"device_info"</span>, <span class="string">""</span>);</span><br><span class="line"><span class="comment">//标价币种</span></span><br><span class="line">data.put(<span class="string">"fee_type"</span>, <span class="string">"CNY"</span>);</span><br><span class="line"><span class="comment">//标价金额 支付金额  单位为  分</span></span><br><span class="line">data.put(<span class="string">"total_fee"</span>, <span class="string">"total_fee"</span>);</span><br><span class="line"><span class="comment">//终端IP java后台从请求头中解析得到的微信端页面请求来的IP</span></span><br><span class="line">data.put(<span class="string">"spbill_create_ip"</span>, <span class="string">"ip"</span>);</span><br><span class="line"><span class="comment">//通知地址</span></span><br><span class="line">data.put(<span class="string">"notify_url"</span>, <span class="string">"微信支付处理成功后回调地址"</span>);</span><br><span class="line"><span class="comment">//交易类型</span></span><br><span class="line">data.put(<span class="string">"trade_type"</span>, <span class="string">"JSAPI"</span>);</span><br><span class="line"><span class="comment">//JSAPI 方式 支付时 必须传openid</span></span><br><span class="line">data.put(<span class="string">"openid"</span>,<span class="string">"openid"</span>);</span><br><span class="line"><span class="comment">//商品ID  trade_type=NATIVE时，此参数必传。此参数为二维码中包含的商品ID，商户自行定义。</span></span><br><span class="line"><span class="comment">//data.put("product_id", "12");</span></span><br></pre></td></tr></table></figure>

<p>调用统一下单：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">MyConfig config = <span class="keyword">new</span> MyConfig();</span><br><span class="line">WXPay wxpay = <span class="keyword">new</span> WXPay(config);</span><br><span class="line"><span class="comment">//统一下单。参数 data 就是上面的 map.</span></span><br><span class="line"><span class="comment">//wxpay.unifiedOrder 方法内部会自动为我们生成签名 并将参数转换成 xml 。然后 调用微信接口将结果返回。</span></span><br><span class="line">Map&lt;String, String&gt; resp = wxpay.unifiedOrder(data);</span><br></pre></td></tr></table></figure>

<p>成功后我们就能拿到 prepay_id 了</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="string">"SUCCESS"</span>.equals(resp.get(<span class="string">"return_code"</span>)))&#123;</span><br><span class="line">  <span class="comment">//业务 ok</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="string">"SUCCESS"</span>.equals(resp.get(<span class="string">"result_code"</span>)))&#123;</span><br><span class="line">    <span class="comment">//预支付会话标识  </span></span><br><span class="line">    String prepay_id = resp.get(<span class="string">"prepay_id"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="组织参数并返回给前端"><a href="#组织参数并返回给前端" class="headerlink" title="组织参数并返回给前端"></a>组织参数并返回给前端</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">Map map = <span class="keyword">new</span> HashMap&lt;String,String&gt;();</span><br><span class="line">map.put(<span class="string">"appId"</span>,appId);</span><br><span class="line">map.put(<span class="string">"timeStamp"</span>,String.valueOf(System.currentTimeMillis() / <span class="number">1000</span>));</span><br><span class="line">map.put(<span class="string">"nonceStr"</span>,RandomString.make(<span class="number">16</span>));</span><br><span class="line"><span class="comment">//prepay_id 就是一字符串。但这里需拼接 prepay_id=</span></span><br><span class="line">map.put(<span class="string">"package"</span>,<span class="string">"prepay_id="</span>+prepay_id);</span><br><span class="line"><span class="comment">//签名类型 得与统一下单 wxpay.unifiedOrder 中的保持一致。</span></span><br><span class="line"><span class="comment">//看到 微信文档中有的地方会说 签名方式默认 MD5。但我这边 wxpay.unifiedOrder 里就是 HMAC-SHA256。哈哈 坑死人不偿命的那种</span></span><br><span class="line"><span class="comment">//不知道官方 demo wxpay.unifiedOrder 的签名以后会不会改。这里最好要自己 debug 看下</span></span><br><span class="line">map.put(<span class="string">"signType"</span>,<span class="string">"HMAC-SHA256"</span>);</span><br><span class="line"><span class="comment">// 签名 说明：https://developers.weixin.qq.com/doc/offiaccount/OA_Web_Apps/JS-SDK.html#58</span></span><br><span class="line"><span class="comment">//WXPayUtil.generateSignature 为官方 demo 里的方法  拿过来用就是了</span></span><br><span class="line">String sign = WXPayUtil.generateSignature(map,mchkey, WXPayConstants.SignType.HMACSHA256);</span><br><span class="line">map.put(<span class="string">"paySign"</span>,sign);</span><br><span class="line"><span class="keyword">return</span> ApiResult.ok(map);</span><br></pre></td></tr></table></figure>

<h5 id="唤起支付"><a href="#唤起支付" class="headerlink" title="唤起支付"></a>唤起支付</h5><p>唤起支付所在的的页面是需要在配置的</p>
<p>相关文档：<a href="https://pay.weixin.qq.com/wiki/doc/api/jsapi.php?chapter=7_3" target="_blank" rel="noopener">https://pay.weixin.qq.com/wiki/doc/api/jsapi.php?chapter=7_3</a></p>
<p>一切就绪 前端 js 可通过按钮来触发这段代码</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">wxpay:<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">//后台预支付（统一下单） 接口地址</span></span><br><span class="line">  <span class="keyword">let</span> url = process.env.API_PROXY_ROOT+<span class="string">"/weixin/prepay-order"</span>;</span><br><span class="line">  <span class="keyword">let</span> params = &#123;</span><br><span class="line"><span class="comment">//根据业务接口的设定 来传</span></span><br><span class="line">  &#125;;</span><br><span class="line">  api.post(url,&#123;<span class="attr">params</span>:params&#125;).then(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> con = res.data;</span><br><span class="line">    <span class="built_in">console</span>.log(con);</span><br><span class="line">    <span class="keyword">if</span> (con.success==<span class="literal">true</span>)&#123;</span><br><span class="line">      <span class="comment">//唤起支付 这里的 con.data 就是上面组织的 参数 map 哦</span></span><br><span class="line">      wx.chooseWXPay(&#123;</span><br><span class="line">        timestamp: con.data.timeStamp, <span class="comment">// 支付签名时间戳，注意微信jssdk中的所有使用timestamp字段均为小写。但最新版的支付后台生成签名使用的timeStamp字段名需大写其中的S字符</span></span><br><span class="line">        nonceStr: con.data.nonceStr, <span class="comment">// 支付签名随机串，不长于 32 位</span></span><br><span class="line">        package: con.data.package, <span class="comment">// 统一支付接口返回的prepay_id参数值，提交格式如：prepay_id=\*\*\*）</span></span><br><span class="line">        signType: con.data.signType, <span class="comment">// 签名方式</span></span><br><span class="line">        paySign: con.data.paySign, <span class="comment">// 支付签名</span></span><br><span class="line">        success: <span class="function"><span class="keyword">function</span> (<span class="params">res</span>) </span>&#123;</span><br><span class="line">          <span class="comment">// 支付成功后的回调函数</span></span><br><span class="line">          <span class="comment">//如果清空购物车 调用 api 清空购物车</span></span><br><span class="line">          <span class="keyword">debugger</span></span><br><span class="line">          <span class="built_in">console</span>.log(res);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>

<p>如果一次性成功！那么恭喜你太幸运了。</p>
<h3 id="关于调试"><a href="#关于调试" class="headerlink" title="关于调试"></a>关于调试</h3><ul>
<li>在整个开发配置中微信让我们配置了一些个域名或目录（如支付目录，js 安全域名等），这些其实都限制了我们在调试的时候必须使用域名。我的做法是把域名解析到自己宽带的IP（前提是网络拨号得到的IP，如果不是的话可打供应商电话让其配置），然后在路由器配置虚拟服务器和端口转发，转到自己电脑的ip和端口上。这样通过域名访问的公众号页面经过路由器由转到我们本地来了。</li>
<li><strong>此外唤起支付的 js 在开发者工具上执行是没有效果的</strong>。会提示：chooseWXPay:<strong>没有此SDK或暂不支持此SDK模拟</strong>。是因为这个 js 只有在手机微信的浏览器执行才能被识别。微信开发者工具有个预览功能，点击会有二维码。在手机与电脑在同一网络环境下手机微信扫码该页面就能在微信里打开了。自此就能正常唤起支付了。</li>
</ul>
<h3 id="关于工具"><a href="#关于工具" class="headerlink" title="关于工具"></a>关于工具</h3><ul>
<li>首先前端代码运行后请放在<strong>微信开发者工具</strong>中调试。这个工具的使用需要登录微信，从而在获取网页授权的时候是比较方便的。工具地址：<a href="https://developers.weixin.qq.com/miniprogram/dev/devtools/devtools.html" target="_blank" rel="noopener">https://developers.weixin.qq.com/miniprogram/dev/devtools/devtools.html</a></li>
<li>微信提供了两个签名工具来帮助我们验证我们的签名代码，这极大的缩短了我们爬坑的时间<ol>
<li>ticket 签名工具：<a href="https://mp.weixin.qq.com/debug/cgi-bin/sandbox?t=jsapisign" target="_blank" rel="noopener">https://mp.weixin.qq.com/debug/cgi-bin/sandbox?t=jsapisign</a></li>
<li>支付接口（统一下单等地方）签名工具：<a href="https://pay.weixin.qq.com/wiki/doc/api/jsapi.php?chapter=20_1" target="_blank" rel="noopener">https://pay.weixin.qq.com/wiki/doc/api/jsapi.php?chapter=20_1</a></li>
</ol>
</li>
</ul>
<h3 id="关于公众号的一些配置"><a href="#关于公众号的一些配置" class="headerlink" title="关于公众号的一些配置"></a>关于公众号的一些配置</h3><ul>
<li><p>公众号 -&gt; 基本配置</p>
<p><img data-src="https://gitee.com/wu_zhiyong/pic-bed/raw/master/img/image-20210305162815211.png" alt="image-20210305162815211"></p>
<ol>
<li>开发者密码：一些配置项要用到</li>
<li>ip 白名单：白名单中的 IP 才能调微信的接口</li>
<li>服务器配置：配置成功才能成为开发者。然后才可以在公众平台网站中申请微信认证，认证成功后，将获得更多接口权限</li>
</ol>
</li>
<li><p>公众号-&gt; 开发者工具 -&gt; web 开发者工具</p>
<p><img data-src="https://gitee.com/wu_zhiyong/pic-bed/raw/master/img/image-20210305165240649.png" alt="image-20210305165240649"></p>
<p>绑定过的开发者账号才能登录微信开发者工具。绑定的对象必须是关注了该公众号的用户。</p>
</li>
<li><p>公众号 -&gt; 公众号设置</p>
<p><img data-src="https://gitee.com/wu_zhiyong/pic-bed/raw/master/img/image-20210305165514980.png" alt="image-20210305165514980"></p>
<p>在这些域名下的前端服务才能调用微信 js 功能。</p>
</li>
<li><p>微信商户平台 -&gt; 账户中心 -&gt; API安全</p>
<p><img data-src="https://gitee.com/wu_zhiyong/pic-bed/raw/master/img/image-20210305165854877.png" alt="image-20210305165854877"></p>
<p>API证书与API密钥调用支付接口需用到。</p>
<p>商户信息的商户 id 支付接口也会用到。</p>
</li>
</ul>
<h3 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h3><p>微信开发文档：<a href="https://developers.weixin.qq.com/doc/offiaccount/Getting_Started/Overview.html" target="_blank" rel="noopener">https://developers.weixin.qq.com/doc/offiaccount/Getting_Started/Overview.html</a></p>
<p>JSAPI 开发文档：<a href="https://pay.weixin.qq.com/wiki/doc/api/jsapi.php?chapter=1_1" target="_blank" rel="noopener">https://pay.weixin.qq.com/wiki/doc/api/jsapi.php?chapter=1_1</a></p>
<p>博客：<a href="https://blog.csdn.net/u013391488/article/details/79314041" target="_blank" rel="noopener">https://blog.csdn.net/u013391488/article/details/79314041</a></p>

    </div>

    
    
    
        <div class="reward-container">
  <div></div>
  <button onclick="var qr = document.getElementById('qr'); qr.style.display = (qr.style.display === 'none') ? 'block' : 'none';">
    打赏
  </button>
  <div id="qr" style="display: none;">
      
      <div style="display: inline-block;">
        <img src="https://gitee.com/wu_zhiyong/pic-bed/raw/master/img/微信图片_20200501220918.png" alt="wuzhiyong 微信支付">
        <p>微信支付</p>
      </div>
      
      <div style="display: inline-block;">
        <img src="https://gitee.com/wu_zhiyong/pic-bed/raw/master/img/微信图片_20200501220907.jpg" alt="wuzhiyong 支付宝">
        <p>支付宝</p>
      </div>

  </div>
</div>


      <footer class="post-footer">
          <div class="post-tags">
              <a href="/blog.github.io/tags/springboot/" rel="tag"># springboot</a>
              <a href="/blog.github.io/tags/java/" rel="tag"># java</a>
              <a href="/blog.github.io/tags/%E5%BE%AE%E4%BF%A1/" rel="tag"># 微信</a>
              <a href="/blog.github.io/tags/%E6%94%AF%E4%BB%98/" rel="tag"># 支付</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/blog.github.io/%E8%B7%AF%E7%94%B1%E5%99%A8%E8%AE%BE%E7%BD%AE%E5%A4%96%E7%BD%91%E8%AE%BF%E9%97%AE/" rel="prev" title="路由器设置外网访问">
      <i class="fa fa-chevron-left"></i> 路由器设置外网访问
    </a></div>
      <div class="post-nav-item">
    <a href="/blog.github.io/python%E5%AE%89%E8%A3%85for-win/" rel="next" title="python安装for-win">
      python安装for-win <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          
    <div class="comments" id="valine-comments"></div>

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#必要条件"><span class="nav-number">1.</span> <span class="nav-text">必要条件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#实现步骤"><span class="nav-number">2.</span> <span class="nav-text">实现步骤</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#首要目标"><span class="nav-number">2.1.</span> <span class="nav-text">首要目标</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#第一步：网页授权"><span class="nav-number">2.2.</span> <span class="nav-text">第一步：网页授权</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#引导用户进入授权页面同意授权，获取code"><span class="nav-number">2.2.1.</span> <span class="nav-text">引导用户进入授权页面同意授权，获取code</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#通过code换取网页授权access-token"><span class="nav-number">2.2.2.</span> <span class="nav-text">通过code换取网页授权access_token</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#第二步：-微信-js-sdk-初始化配置"><span class="nav-number">2.3.</span> <span class="nav-text">第二步： 微信 js-sdk 初始化配置</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#步骤一：绑定域名"><span class="nav-number">2.3.1.</span> <span class="nav-text">步骤一：绑定域名</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#步骤二：引入JS文件"><span class="nav-number">2.3.2.</span> <span class="nav-text">步骤二：引入JS文件</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#步骤三：通过config接口注入权限验证配置"><span class="nav-number">2.3.3.</span> <span class="nav-text">步骤三：通过config接口注入权限验证配置</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#第三步：唤起支付"><span class="nav-number">2.4.</span> <span class="nav-text">第三步：唤起支付</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#统一下单"><span class="nav-number">2.4.1.</span> <span class="nav-text">统一下单</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#组织参数并返回给前端"><span class="nav-number">2.4.2.</span> <span class="nav-text">组织参数并返回给前端</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#唤起支付"><span class="nav-number">2.4.3.</span> <span class="nav-text">唤起支付</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#关于调试"><span class="nav-number">3.</span> <span class="nav-text">关于调试</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#关于工具"><span class="nav-number">4.</span> <span class="nav-text">关于工具</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#关于公众号的一些配置"><span class="nav-number">5.</span> <span class="nav-text">关于公众号的一些配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#参考文档"><span class="nav-number">6.</span> <span class="nav-text">参考文档</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">wuzhiyong</p>
  <div class="site-description" itemprop="description">吴志勇的博客</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/blog.github.io/archives/">
        
          <span class="site-state-item-count">40</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/blog.github.io/categories/">
          
        <span class="site-state-item-count">10</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/blog.github.io/tags/">
          
        <span class="site-state-item-count">34</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="mailto:wzy563653092@gmail.com" title="E-Mail → mailto:wzy563653092@gmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">wuzhiyong</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
    <span title="站点总字数">260k</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">3:56</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> 强力驱动
  </div>
  <div class="addthis_inline_share_toolbox">
    <script src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5eae29bdce1a511b" async="async"></script>
  </div>

        






<script>
  (function() {
    function leancloudSelector(url) {
      url = encodeURI(url);
      return document.getElementById(url).querySelector('.leancloud-visitors-count');
    }

    function addCount(Counter) {
      var visitors = document.querySelector('.leancloud_visitors');
      var url = decodeURI(visitors.id);
      var title = visitors.dataset.flagTitle;

      Counter('get', '/classes/Counter?where=' + encodeURIComponent(JSON.stringify({ url })))
        .then(response => response.json())
        .then(({ results }) => {
          if (results.length > 0) {
            var counter = results[0];
            leancloudSelector(url).innerText = counter.time + 1;
            Counter('put', '/classes/Counter/' + counter.objectId, { time: { '__op': 'Increment', 'amount': 1 } })
              .catch(error => {
                console.error('Failed to save visitor count', error);
              });
          } else {
              Counter('post', '/classes/Counter', { title, url, time: 1 })
                .then(response => response.json())
                .then(() => {
                  leancloudSelector(url).innerText = 1;
                })
                .catch(error => {
                  console.error('Failed to create', error);
                });
          }
        })
        .catch(error => {
          console.error('LeanCloud Counter Error', error);
        });
    }

    function showTime(Counter) {
      var visitors = document.querySelectorAll('.leancloud_visitors');
      var entries = [...visitors].map(element => {
        return decodeURI(element.id);
      });

      Counter('get', '/classes/Counter?where=' + encodeURIComponent(JSON.stringify({ url: { '$in': entries } })))
        .then(response => response.json())
        .then(({ results }) => {
          for (let url of entries) {
            let target = results.find(item => item.url === url);
            leancloudSelector(url).innerText = target ? target.time : 0;
          }
        })
        .catch(error => {
          console.error('LeanCloud Counter Error', error);
        });
    }

    let { app_id, app_key, server_url } = {"enable":true,"app_id":"jOjNqcMeMLL4ntoMdf13veTb-MdYXbMMI","app_key":"v50rUeYs7yeT6hECN7XAhYYM","server_url":null,"security":false};
    function fetchData(api_server) {
      var Counter = (method, url, data) => {
        return fetch(`${api_server}/1.1${url}`, {
          method,
          headers: {
            'X-LC-Id'     : app_id,
            'X-LC-Key'    : app_key,
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(data)
        });
      };
      if (CONFIG.page.isPost) {
        // if (CONFIG.hostname !== location.hostname) return;
        addCount(Counter);
      } else if (document.querySelectorAll('.post-title-link').length >= 1) {
        showTime(Counter);
      }
    }

    let api_server = app_id.slice(-9) !== '-MdYXbMMI' ? server_url : `https://${app_id.slice(0, 8).toLowerCase()}.api.lncldglobal.com`;

    if (api_server) {
      fetchData(api_server);
    } else {
      fetch('https://app-router.leancloud.cn/2/route?appId=' + app_id)
        .then(response => response.json())
        .then(({ api_server }) => {
          fetchData('https://' + api_server);
        });
    }
  })();
</script>


      </div>
    </footer>
  </div>

  
  <script src="/blog.github.io/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script>
  <script src="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/lozad@1/dist/lozad.min.js"></script>
  <script src="/blog.github.io/lib/velocity/velocity.min.js"></script>
  <script src="/blog.github.io/lib/velocity/velocity.ui.min.js"></script>

<script src="/blog.github.io/js/utils.js"></script>

<script src="/blog.github.io/js/motion.js"></script>


<script src="/blog.github.io/js/schemes/muse.js"></script>


<script src="/blog.github.io/js/next-boot.js"></script>




  




  
<script src="/blog.github.io/js/local-search.js"></script>













  

  


<script>
NexT.utils.loadComments(document.querySelector('#valine-comments'), () => {
  NexT.utils.getScript('//unpkg.com/valine/dist/Valine.min.js', () => {
    var GUEST = ['nick', 'mail', 'link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item => {
      return GUEST.includes(item);
    });
    new Valine({
      el         : '#valine-comments',
      verify     : false,
      notify     : false,
      appId      : 'jOjNqcMeMLL4ntoMdf13veTb-MdYXbMMI',
      appKey     : 'v50rUeYs7yeT6hECN7XAhYYM',
      placeholder: "Just go go",
      avatar     : 'mm',
      meta       : guest,
      pageSize   : '10' || 10,
      visitor    : false,
      lang       : 'zh-cn' || 'zh-cn',
      path       : location.pathname,
      recordIP   : false,
      serverURLs : ''
    });
  }, window.Valine);
});
</script>

</body>
</html>
